const t=new BroadcastChannel("myfaveTT"),e=new BroadcastChannel("params-guard");let i,n;const r=new WeakMap,o=new WeakMap,s=new WeakMap,a=new WeakMap,c=new WeakMap;let u={get(t,e,i){if(t instanceof IDBTransaction){if("done"===e)return o.get(t);if("objectStoreNames"===e)return t.objectStoreNames||s.get(t);if("store"===e)return i.objectStoreNames[1]?void 0:i.objectStore(i.objectStoreNames[0])}return d(t[e])},set:(t,e,i)=>(t[e]=i,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function l(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(n||(n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(f(this),e),d(r.get(this))}:function(...e){return d(t.apply(f(this),e))}:function(e,...i){const n=t.call(f(this),e,...i);return s.set(n,e.sort?e.sort():[e]),d(n)}}function h(t){return"function"==typeof t?l(t):(t instanceof IDBTransaction&&function(t){if(o.has(t))return;const e=new Promise(((e,i)=>{const n=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",o),t.removeEventListener("abort",o)},r=()=>{e(),n()},o=()=>{i(t.error||new DOMException("AbortError","AbortError")),n()};t.addEventListener("complete",r),t.addEventListener("error",o),t.addEventListener("abort",o)}));o.set(t,e)}(t),e=t,(i||(i=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>e instanceof t))?new Proxy(t,u):t);var e}function d(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,i)=>{const n=()=>{t.removeEventListener("success",r),t.removeEventListener("error",o)},r=()=>{e(d(t.result)),n()},o=()=>{i(t.error),n()};t.addEventListener("success",r),t.addEventListener("error",o)}));return e.then((e=>{e instanceof IDBCursor&&r.set(e,t)})).catch((()=>{})),c.set(e,t),e}(t);if(a.has(t))return a.get(t);const e=h(t);return e!==t&&(a.set(t,e),c.set(e,t)),e}const f=t=>c.get(t);const w=["get","getKey","getAll","getAllKeys","count"],p=["put","add","delete","clear"],y=new Map;function m(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(y.get(e))return y.get(e);const i=e.replace(/FromIndex$/,""),n=e!==i,r=p.includes(i);if(!(i in(n?IDBIndex:IDBObjectStore).prototype)||!r&&!w.includes(i))return;const o=async function(t,...e){const o=this.transaction(t,r?"readwrite":"readonly");let s=o.store;return n&&(s=s.index(e.shift())),(await Promise.all([s[i](...e),r&&o.done]))[0]};return y.set(e,o),o}u=(t=>({...t,get:(e,i,n)=>m(e,i)||t.get(e,i,n),has:(e,i)=>!!m(e,i)||t.has(e,i)}))(u);const v={t:function(t,e,{blocked:i,upgrade:n,blocking:r,terminated:o}={}){const s=indexedDB.open(t,e),a=d(s);return n&&s.addEventListener("upgradeneeded",(t=>{n(d(s.result),t.oldVersion,t.newVersion,d(s.transaction))})),i&&s.addEventListener("blocked",(()=>i())),a.then((t=>{o&&t.addEventListener("close",(()=>o())),r&&t.addEventListener("versionchange",(()=>r()))})).catch((()=>{})),a}("myfaveTT",2,{upgrade(t,e,i,n){switch(e){case 0:t.createObjectStore("likesCache"),t.createObjectStore("followingCache");case 1:t.createObjectStore("misc")}}})},_={i:async t=>(await v.t).get("misc",t),o:async(t,e)=>(await v.t).put("misc",e,t)},g="chrome-extension://gmajiifkcmjkehmngbopoobeplhoegad";function k(t,e){ui.postMessage({type:t,payload:e},g)}const b=k;function $(t,e){ui.postMessage({type:t,payload:e},g)}function T(t,e,i){k(1,{err:t,location:e,silently:i})}async function E(t,e){try{const i=e.split("/"),n=i.pop();let r=t;for(const t of i)r=await r.getDirectoryHandle(t,{create:!0});return await r.getFileHandle(n,{create:!0})}catch(t){throw T(t,"gfh29"),t}}async function S(t,e){const i=await t.createWritable();await i.write(e),await i.close()}const C={schemaVersion:1,user:{uid:"",id:"",uniqueId:"",nickname:""},authors:{},videos:{},likes:{downloadStatus:"unset",officialList:[],downloaded:new Set,lastRun:{collect:0,download:0}},following:{officialAuthorList:new Set,started:new Set,notInterested:new Set,downloadLog:{},lastRun:{}}};function D(t){return e=function(t){return JSON.stringify(t,(function(t,e){return e instanceof Set?[...e]:"string"==typeof e?e.replaceAll("`","èƒŒð“„¹å‰ƒ").replaceAll("${","â‘€â¦ƒ"):e}))}(t),"db=String.raw`{}`;".slice(0,"db=String.raw`{}`;".indexOf("{"))+e+"db=String.raw`{}`;".slice("db=String.raw`{}`;".lastIndexOf("}")+1);var e}function x(t){return""===t?C:function(t){const e=JSON.parse(t,(function(t,e){switch(t){case"downloaded":case"notInterested":case"started":case"officialAuthorList":if(Array.isArray(e))return new Set(e)}return"string"==typeof e?e.replaceAll("â‘€â¦ƒ","${").replaceAll("èƒŒð“„¹å‰ƒ","`"):e}));for(const[t,i]of Object.entries(e.following.downloadLog))e.following.downloadLog[t]=new Set(i);return e}(function(t){const e=t.indexOf("{"),i=t.lastIndexOf("}")-t.length+1;return t.slice(e,i)}(t))}const I=new class{constructor(){this.u=null,this.l=null}async h(t,e){this.u=t,this.l=e,k(8),_.o("archiveFolderHandle",t)}async p(){try{S(await E(this.u,"data/.appdata/db.js"),D(this.l))}catch(t){T(t,"a42")}}async m(t){try{const{archiveHtml:e,appJs:i}=t;S(await E(this.u,"Archive.html"),e),S(await E(this.u,"data/.appdata/app.js"),i)}catch(t){T(t,"a58")}}v(t){t.forEach((t=>{const{id:e,uniqueId:i,nickname:n,signature:r}=t.user,{followerCount:o,videoCount:s,heartCount:a}=t.stats,c={uniqueIds:[i],nicknames:[n],followerCount:o,heartCount:a,videoCount:s,signature:r},u=this.l.authors[e];u&&(c.uniqueIds=[...new Set([i,...u.uniqueIds])],c.nicknames=[...new Set([n,...u.nicknames])]),this.l.authors[e]=c})),this.l.following.officialAuthorList=new Set(t.map((t=>t.user.id))),this.p()}async _(t){try{if(!this.l.following.started.has(t)&&!this.l.following.downloadLog[t])return;this.l.following.started.delete(t),delete this.l.following.downloadLog[t],await this.p();let e=await this.u.getDirectoryHandle("data");e=await e.getDirectoryHandle("Following"),await e.removeEntry(t,{recursive:!0})}catch(t){T(t,"purge failed","silently")}}},j={g(t,e){k(2,{event:t,params:e})}};let A=0;function O(){let t;return t=A<=2?5:2+5*(A-2),1e3*t}const B={};async function M(){const t=[];Object.entries(B).forEach((async([e,i])=>{const{createTime:n,cover:r,video:o}=i;if(Boolean(r&&o))t.push(async function(t){var e;const{startWritingToDiskTime:i,key:n,likedOrFollowing:r,itemData:{id:o,author:s},cover:a,video:c,size:u}=t;if(0!==i){return Date.now()-i<1e4?void 0:(delete B[n],void j.g("stuck in writing"))}t.startWritingToDiskTime=Date.now();try{const t="liked"===r?"data/Likes":`data/Following/${s.id}`,i=`${t}/covers/${o}.jpg`,l=`${t}/videos/${o}.mp4`,h=E(I.u,i).then((t=>S(t,a))),d=E(I.u,l).then((t=>S(t,c)));if(await Promise.all([h,d]),I.l.videos[o].size=u,"following"===r){const t=I.l.following.downloadLog;t[e=s.id]||(t[e]=new Set),t[s.id].add(o)}else I.l.likes.downloaded.add(o)}catch(t){T(t,"ts71","silently")}finally{delete B[n]}}(i));else{Date.now()-n>1e5&&(delete B[e],j.g("took over 30 seconds"))}})),t.length&&(await Promise.allSettled(t),await I.p())}const L=new class{addNew(t){B[t.key]=t,A=Object.keys(B).length}k(t,e){B[t]&&(B[t].cover=e,M())}$(t,e){B[t]&&(B[t].size=e)}T(t,e){B[t]&&(B[t].video=e,M())}S(t){B[t],B[t]&&delete B[t]}};function W(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)}function N(t,e,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(t,i):r?r.value=i:e.set(t,i),i}function U(t){return new Promise((e=>{setTimeout((()=>{e(t)}),t)}))}function F(t){const e=5e3,i={unlocked:["unlock_0_to_1000_likes_(free)"],cap:1e3,nextToBuy:"unlock_1001_to_5000_likes",lineItemDescription:'"Enable downloading more than 1000, up to 5000 videos from your Likes on TikTok."'};if(0===t)return i;const n=[i.unlocked[0]],r=e*t,o=r+e,s=`unlock_${r+1}_to_${o}_likes`,a=`"Enable downloading more than ${r}, up to ${o} videos from your Likes on TikTok."`;for(let e=0;e<t;e++)n.push(F(e)?.nextToBuy);return{unlocked:n,cap:r,nextToBuy:s,lineItemDescription:a}}const q=/^\s+|\s+$/g,R=/^[-+]0x[0-9a-f]+$/i,P=/^0b[01]+$/i,J=/^0o[0-7]+$/i,H=parseInt,z="object"==typeof global&&global&&global.Object===Object&&global,V="object"==typeof self&&self&&self.Object===Object&&self,K=z||V||Function("return this")(),G=Object.prototype.toString,Q=Math.max,X=Math.min,Y=function(){return K.Date.now()};function Z(t,e,i){let n,r,o,s,a,c,u=0,l=!1,h=!1,d=!0;if("function"!=typeof t)throw new TypeError("Expected a function");function f(e){const i=n,o=r;return n=r=void 0,u=e,s=t.apply(o,i),s}function w(t){return u=t,a=setTimeout(y,e),l?f(t):s}function p(t){const i=t-c;return void 0===c||i>=e||i<0||h&&t-u>=o}function y(){const t=Y();if(p(t))return m(t);a=setTimeout(y,function(t){const i=e-(t-c);return h?X(i,o-(t-u)):i}(t))}function m(t){return a=void 0,d&&n?f(t):(n=r=void 0,s)}function v(){const t=Y(),i=p(t);if(n=arguments,r=this,c=t,i){if(void 0===a)return w(c);if(h)return a=setTimeout(y,e),f(c)}return void 0===a&&(a=setTimeout(y,e)),s}return e=et(e)||0,tt(i)&&(l=!!i.leading,h="maxWait"in i,o=h?Q(et(i.maxWait)||0,e):o,d="trailing"in i?!!i.trailing:d),v.cancel=function(){void 0!==a&&clearTimeout(a),u=0,n=c=r=a=void 0},v.flush=function(){return void 0===a?s:m(Y())},v}function tt(t){const e=typeof t;return!!t&&("object"==e||"function"==e)}function et(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&"[object Symbol]"==G.call(t)}(t))return NaN;if(tt(t)){const e="function"==typeof t.valueOf?t.valueOf():t;t=tt(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(q,"");const e=P.test(t);return e||J.test(t)?H(t.slice(2),e?2:8):R.test(t)?NaN:+t}const it={};const nt=function(t,e,i){let n=!0,r=!0;if("function"!=typeof t)throw new TypeError("Expected a function");return tt(i)&&(n="leading"in i?!!i.leading:n,r="trailing"in i?!!i.trailing:r),Z(t,e,{leading:n,maxWait:e,trailing:r})}((function(){Object.entries(it).forEach((async([t,e])=>{const i=await E(I.u,`data/Following/Avatars/${t}`),n=await i.createWritable();await n.write(e),await n.close(),delete it[t]}))}),7e3);async function rt(t,e){const i=await E(I.u,`data/Following/Avatars/${e}`),n=await i.getFile();if(n.size>0){const t=6048e5,e=(6*Math.random()+1)*t;if(Date.now()-n.lastModified<e)return}const r=await fetch(t),o=r.headers.get("Content-Type");if("image/jpeg"!==o)return void T(new Error(`avatar type is ${o}`),"daa9","silently");const s=await r.blob();it[e]=s,nt(),e.includes("small")&&await U(200),e.includes("large")&&await U(2e3)}const ot={C:!1},st=t=>e=>{const i={};for(const n of t)i[n]=e[n];return i},at=t=>e=>{const i={};return e.forEach((e=>{i[e[t]]=e})),i};function ct(t){const e=st(["id","desc","createTime","itemMute"])(t);return e.video=st(["id","cover","playAddr","downloadAddr","format"])(t.video),e.stats=st(["diggCount","playCount"])(t.stats),e.author=st(["id","uniqueId","nickname","avatarLarger"])(t.author),e.authorStats=st(["followerCount","heartCount","videoCount"])(t.authorStats),e}function ut(t){return st(["id","uniqueId","nickname","avatarLarger","avatarThumb","signature"])(t.user)}const lt=new class{constructor(){this.D="initial",this.I={}}async j(){if(window.__NEXT_DATA__)try{this.I=window.__NEXT_DATA__.props.initialProps,this.D="next"}catch(t){T(t,"ac26"),this.D="error"}else if(window.SIGI_STATE)try{this.I=window.SIGI_STATE.AppContext.appContext,this.D="sigi"}catch(t){T(t,"ac37"),this.D="error"}else try{const t=await fetch("/node-webapp/api/app-context"),e=await t.json();0===e.statusCode?(this.I=e,this.D="fetched"):(T(new Error(e),"ac49"),this.D="error")}catch(t){T(t,"ac52"),this.D="error"}j.g("app_context",{status:this.D}),this.D}A(){const{$wid:t,$region:e,$os:i,$language:n,$user:r,$domains:o}=this.I;if(!(t&&e&&i&&n))return T(new Error(JSON.stringify({$wid:t,$region:e,$os:i,$language:n})),"ac64"),!1;if(!r)return!0;const{uid:s,uniqueId:a,secUid:c,nickName:u}=r;return s&&a&&c&&u?(o||T(new Error("$domains: "+JSON.stringify({$domains:o})),"ac86","silently"),!0):(T(new Error(JSON.stringify({uid:s,uniqueId:a,secUid:c,nickName:u})),"ac75"),!1)}};function ht(){var t;return{aid:"1988",app_name:"tiktok_web",channel:"tiktok_web",device_platform:"web_pc",referer:document.referrer,cookie_enabled:navigator.cookieEnabled,screen_width:screen.width,screen_height:screen.height,browser_language:navigator.language,browser_platform:navigator.platform,browser_name:navigator.appCodeName,browser_version:navigator.appVersion,browser_online:navigator.onLine,verifyFp:null===(t=document.cookie.match(/s_v_web_id=(\w+)/))||void 0===t?void 0:t[1],is_page_visible:!0,focus_state:!0,is_fullscreen:window.matchMedia("(display-mode: fullscreen)").matches,history_len:window.history.length,battery_info:1,tz_name:Intl.DateTimeFormat().resolvedOptions().timeZone}}function dt(){const{$wid:t,$region:e,$language:i,$os:n,$user:r}=lt.I;return{device_id:t,region:e,priority_region:r.region,os:n,app_language:i,webcast_language:i}}function ft(){const t=lt.I.$user;return{id:(null==t?void 0:t.uid)||null,secUid:(null==t?void 0:t.secUid)||null,uniqueId:(null==t?void 0:t.uniqueId)||null,nickname:(null==t?void 0:t.nickName)||null}}function wt(){const{$language:t}=lt.I,{secUid:e}=ft();if(!e)throw new Error("no secUid or id @ gsp19");return{from_page:"user",secUid:e,language:t}}var pt;class yt{constructor(t){var e;pt.set(this,void 0);let i=null===(e=lt.I.$domains)||void 0===e?void 0:e.mTApi;(null==i?void 0:i.startsWith("https://"))||(i="https://m.tiktok.com"),N(this,pt,"likes"===t?new URL(`${i}/api/favorite/item_list/`):new URL(`${i}/api/user/list/`),"f");const n={...ht(),...dt(),..."following"===t?{scene:21,from_page:"fyp"}:wt()};return Object.entries(n).forEach((([t,e])=>{W(this,pt,"f").searchParams.set(t,(null==e?void 0:e.toString())||"")})),this}O(t){return W(this,pt,"f").searchParams.set("cursor",t),this}B({maxCursor:t,minCursor:e}){return W(this,pt,"f").searchParams.set("maxCursor",String(t)),W(this,pt,"f").searchParams.set("minCursor",String(e)),this}M(t){return W(this,pt,"f").searchParams.set("count",String(t)),this}L(){return W(this,pt,"f").toString()}}pt=new WeakMap;const mt=1030,vt=["unset","downloading","paused","capped","completed"],_t=["downloading","completed","capped","pausing","paused","resuming"],gt={W:"unset",N:{U(t){k(16,t)},F(t){k(17,t)}},q:{R(t){b(11,{progress:t})},P(t){_t.includes(t)&&b(11,{status:t}),vt.includes(t)&&(I.l.likes.downloadStatus=t)}}};function kt(t){if(!t)return!1;const e=new URL(t),i=e.searchParams.get("expire")||e.searchParams.get("x-expires");if(!i)return!1;return(Number(i+"000")-Date.now())/1e3/60<30}function bt(t){return[t.video.playAddr,t.video.cover].some(kt)}function $t(t){return t.some(bt)}function Tt(t){return{async J(){const e=await v.t,i=await e.get("followingCache",t);return i?$t(i)?[]:i.sort(((t,e)=>t.createTime-e.createTime)):[]},o:async e=>(await v.t).put("followingCache",e,t),async H(t){return(await this.J()).map((t=>t.id)).includes(t.id)}}}function Et(t){const e=at("id")(t),i=t.map((t=>t.id));return[...new Set(i)].map((t=>e[t]))}var St,Ct,Dt,xt,It;const jt=new(It=class{constructor(){St.add(this),this.D="unset",Ct.set(this,"unset")}async V(){try{if(this.D===(this.D="expanding"))return;const t=await W(this,St,"m",Dt).call(this);if(!t)return T(new Error("cannot find authorList"),"ale63","silently"),b(21),void(this.D="failed");if("A"===t.lastChild.tagName)return void(this.D="expanded");if("unset"===W(this,Ct,"f"))return N(this,Ct,t.lastChild.textContent,"f"),W(this,Ct,"f"),void W(this,St,"m",xt).call(this,t);if(W(this,Ct,"f")===t.lastChild.textContent)return void W(this,St,"m",xt).call(this,t);if(t.lastChild.textContent!==W(this,Ct,"f"))return void(this.D="expanded")}catch(t){T(t,"ale92")}}},Ct=new WeakMap,St=new WeakSet,Dt=async function(){await U(1500);let t=document.querySelectorAll(".user-list");0===t.length&&(t=document.querySelectorAll('div[class*="-DivUserContainer"]'));let e=t[t.length-1];if(!e){const i=document.querySelector('a[title="TikTok"]');i&&(i.click(),await U(3e3),t=document.querySelectorAll(".user-list"),0===t.length&&(t=document.querySelectorAll('div[class*="-DivUserContainer"]')),e=t[t.length-1])}return e},xt=async function(t){for(var e,i;;){if(null===(e=t.lastChild)||void 0===e||e.click(),await U(2e3),"A"===t.lastChild.tagName)return void(this.D="expanded");if((null===(i=t.lastChild)||void 0===i?void 0:i.textContent)!==W(this,Ct,"f"))return void(this.D="expanded")}},It);async function At(t){for(jt.V();;){const e=document.querySelector(`a[href$="${t}"]`);if(e)return void e.click();if("expanded"===jt.D)throw new Error("Couldn't find the user to click on the left side. Maybe you just started following this user so it's not on the left sidebar yet. Reload and try again.");await U(500)}}var Ot,Bt;const Mt=new(Bt=class{constructor(){Ot.set(this,void 0)}async h(){N(this,Ot,await _.i("largeVideos")||new Set,"f")}K(t){return W(this,Ot,"f").has(t)}G(t){W(this,Ot,"f").add(t),_.o("largeVideos",W(this,Ot,"f"))}},Ot=new WeakMap,Bt);var Lt,Wt,Nt;class Ut{constructor(t,e){this.X=t,this.Y=e,Lt.add(this),this.Z=this.X.id+this.Y}get tt(){var t;return"liked"===this.Y?Boolean(I.l.likes.downloaded.has(this.X.id)):Boolean(null===(t=I.l.following.downloadLog[this.X.author.id])||void 0===t?void 0:t.has(this.X.id))}get et(){return Mt.K(this.Z)}it(){return bt(this.X)}async nt(){L.addNew({createTime:Date.now(),startWritingToDiskTime:0,key:this.Z,likedOrFollowing:this.Y,itemData:this.X}),await W(this,Lt,"m",Wt).call(this),await W(this,Lt,"m",Nt).call(this)}rt(){try{I.l.videos[this.X.id]=function(t,e){const i={authorId:t.author.id,desc:t.desc,createTime:t.createTime,itemMute:t.itemMute,diggCount:t.stats.diggCount,playCount:t.stats.playCount},n=e.videos[t.id];return Object.assign({},n,i)}(this.X,I.l),I.l.authors[this.X.author.id]=function(t,e){const i={uniqueIds:[t.author.uniqueId],nicknames:[t.author.nickname],followerCount:t.authorStats.followerCount,heartCount:t.authorStats.heartCount,videoCount:t.authorStats.videoCount},n=e.authors[t.author.id];n&&(i.uniqueIds=[...new Set([...i.uniqueIds,...n.uniqueIds])],i.nicknames=[...new Set([...i.nicknames,...n.nicknames])]);return Object.assign({},n,i)}(this.X,I.l)}catch(t){T(t,"i77")}}}Lt=new WeakSet,Wt=async function(){try{const t=await fetch(this.X.video.cover),e=t.headers.get("Content-Type");if("image/jpeg"!==e)throw new Error(`cover type is ${e}`);const i=await t.arrayBuffer();L.k(this.Z,i)}catch(t){L.S(this.Z),"Failed to fetch"===t.message?T(new Error(`fetch failed ${this.X.video.cover}`),"bi60","silently"):T(t,"bi63","silently")}},Nt=async function(){var t,e;const i=new AbortController;try{const t=setTimeout((()=>i.abort()),7e3),e=setTimeout((()=>i.abort()),1e5),n=await fetch(this.X.video.playAddr||this.X.video.downloadAddr,{signal:i.signal});if(clearTimeout(t),!String(n.status).startsWith("2"))throw new Error(`video status code ${n.status}`);if(206===n.status)throw new Error("status 206, video could be very large");const r=n.headers.get("Content-Type");if("video/mp4"!==r)throw new Error(`video type is ${r}`);const o=Number(n.headers.get("Content-Length"));if(!o)throw new Error("unknown video size");const s=(o/1024/1024).toFixed(1)+"MB";if(o>5e7)throw console.error(`video is too large, skip. size: ${s}, url: ${this.X.video.playAddr}`),Mt.G(this.Z),new Error("video is too large, skip");L.$(this.Z,s);const a=await n.arrayBuffer();$("please_resync_this_video",{tempStorageKey:this.Z,arrayBuffer:a}),clearTimeout(e)}catch(n){if(i.abort(),L.S(this.Z),null===(e=null===(t=n.message)||void 0===t?void 0:t.includes)||void 0===e?void 0:e.call(t,"video is too large, skip"))return;"Failed to fetch"===n.message?T(new Error(`fetch failed ${this.X.video.playAddr||this.X.video.downloadAddr}`),"bi127","silently"):T(n,"bi130","silently")}};const Ft={ot:!1};var qt,Rt,Pt,Jt,Ht;const zt={settings:{minimalInterval:1e3,maximalDistance:750,requestIntervalGoal:4e3},on:!1,timeoutId:null,interval:1200,distance:400,lastHttpRequestTime:0,adjust(){Date.now()-this.lastHttpRequestTime>this.settings.requestIntervalGoal?(this.interval=Math.max(this.interval-50,this.settings.minimalInterval),this.distance=Math.min(this.distance+50,this.settings.maximalDistance)):(this.interval+=50,this.distance-=50),this.lastHttpRequestTime=Date.now()}};async function Vt(){try{if(!zt.on)return;if(zt.timeoutId=setTimeout(Vt,zt.interval),"hidden"===document.visibilityState)return;if(!Kt.st)return;!function(){const{scrollHeight:t,scrollTop:e,clientHeight:i}=document.documentElement;return t-e-i<20}()?window.scrollBy({top:zt.distance,left:0,behavior:"smooth"}):(await U(2e3),await Kt.ct())}catch(t){T(t,"scr56")}}const Kt=new(Ht=class{constructor(){qt.add(this),Rt.set(this,[]),this.st=""}async ut(t,e){try{this.st=t,N(this,Rt,[],"f"),document.documentElement.style.overflow="hidden",document.documentElement.style.pointerEvents="none",document.querySelector("aside#myfaveTT-container").style.pointerEvents="auto",await At(e),await U(2500),W(this,qt,"m",Pt).call(this)}catch(t){T(t,"sr48")}}async lt(t){if(0===t.length)return void T(new Error("repeat failed?"),"scr78","silently");const e=function(t){const e=t[0].author.id;if(t.some((t=>t.author.id!==e)))throw new Error("not all videos share the same author");return e}(t);if(e!==this.st)return;if($t(W(this,Rt,"f")))return W(this,qt,"m",Jt).call(this),ee.ht(e),void(this.st="");W(this,Rt,"f").push(...t),gt.N.U(W(this,Rt,"f").length),zt.adjust();if(!await Tt(e).H(W(this,Rt,"f")[W(this,Rt,"f").length-1]))return W(this,Rt,"f").length>mt?(N(this,Rt,W(this,Rt,"f").slice(0,mt),"f"),void await this.ct()):void 0;await this.ct()}async ct(){var t;try{if(!this.st)return;const e=this.st;this.st="",W(this,qt,"m",Jt).call(this);const i=await Tt(e).J(),n=Et(W(this,Rt,"f").concat(i));await Tt(e).o(n),n.length,(t=I.l.following.lastRun)[e]||(t[e]={scroll:0,download:0}),I.l.following.lastRun[e].scroll=Date.now(),I.p(),async function(t){I.l.following.started.add(t);const e=await Tt(t).J();for(const[i,n]of e.entries()){for(;Ft.ot;)await U(500);const r=new Ut(n,"following");if(r.rt(),!r.tt&&!r.et){if(r.it())return void ee.ht(t);gt.N.F({total:e.length,current:i+1}),r.nt().catch((t=>T(t,"doa22","silently"))),await U(O())}}I.l.following.lastRun[t].download=Date.now(),await U(2e3),await ee.ht(t)}(e)}catch(t){T(t,"scr173")}}},Rt=new WeakMap,qt=new WeakSet,Pt=function(){zt.on=!0,zt.timeoutId&&clearTimeout(zt.timeoutId),Vt()},Jt=function(){clearTimeout(zt.timeoutId),zt.on=!1},Ht);var Gt,Qt,Xt,Yt,Zt,te;const ee=new(te=class{constructor(){Gt.add(this),this.dt={},this.ft={alreadyInArchive:[],willAddToArchive:[],notInterested:[]},Qt.set(this,[])}async wt(){try{const t=await async function(){let t=[],[e,i]=[0,0],n=0;do{await U(1e3);const r=new yt("following").B({maxCursor:e,minCursor:i}).M(0===e?10:20);try{const n=await window.fetch(r.L(),{credentials:"include"}),o=await n.json(),{statusCode:s,userList:a}=o;if(0!==s)throw new Error(`Err fetching authors, ${JSON.stringify(o)}`);if(t=(a||[]).concat(t),({maxCursor:e,minCursor:i}=o),b(13,{currentTotal:t.length}),"number"!=typeof e||"number"!=typeof i)throw new Error("Things have changed? Author cursor is no longer number?")}catch(t){if(n++,n<=3)continue;throw t}if(n=0,0===t.length)return[]}while("-1"!==String(e)&&"-1"!==String(i));return t}();if(!ot.C)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");I.v(t),async function(t){for(const e of t){const{id:t,avatarThumb:i}=e.user;try{await rt(i,`small_${t}.jpg`)}catch(t){T(t,"daa60","silently")}}for(const e of t){const{id:t,avatarLarger:i}=e.user;try{await rt(i,`large_${t}.jpg`)}catch(t){T(t,"daa68","silently")}}}(t);const e=t.map(ut);e.forEach((t=>{var e;t.lastChecked=(null===(e=I.l.following.lastRun[t.id])||void 0===e?void 0:e.download)||0})),this.dt=at("id")(e),b(14,{authorDict:this.dt,started:[...I.l.following.started],notInterested:[...I.l.following.notInterested]})}catch(t){T(t,"ff27")}}async yt(t){k(20,"following"),this.ft=t,I.l.following.notInterested=new Set(t.notInterested);const e=[...t.willAddToArchive,...t.alreadyInArchive].sort(((t,e)=>{var i,n;return((null===(i=I.l.following.lastRun[t])||void 0===i?void 0:i.download)||0)-((null===(n=I.l.following.lastRun[e])||void 0===n?void 0:n.download)||0)}));N(this,Qt,e.map((t=>({authorId:t,status:"queued"}))),"f"),await I.p(),k(22,this.vt),W(this,Gt,"m",Xt).call(this),await W(this,Gt,"m",Yt).call(this)}async ht(t){try{const e=W(this,Qt,"f").find((e=>e.authorId===t));e&&(e.status="finished"),await I.p(),await W(this,Gt,"m",Yt).call(this)}catch(t){T(t,"ff101")}}get vt(){const{officialAuthorList:t,started:e,notInterested:i}=I.l.following;return{numFollowed:t.size,numStarted:e.size,numNotInterested:i.size,numCappedOut:[...t].filter((t=>!e.has(t))).filter((t=>!i.has(t))).length}}},Qt=new WeakMap,Gt=new WeakSet,Xt=async function(){for(const t of I.l.following.officialAuthorList)this.ft.alreadyInArchive.includes(t)||this.ft.willAddToArchive.includes(t)||await I._(t)},Yt=async function(){const t=W(this,Qt,"f").find((t=>"queued"===t.status));if(t){t.status="current";const e=this.dt[t.authorId].uniqueId;await Kt.ut(t.authorId,e),k(15,W(this,Qt,"f"))}else W(this,Gt,"m",Zt).call(this)},Zt=function(){k(18,this.vt)},te),ie=new class{constructor(){this._t={}}o(t){this._t=t}};function ne(){try{return F(ie._t.unlocks.likeLevel).cap}catch(t){return T(t,"ud17"),0}}function re(){return ie._t.profile.uid}const oe={async i(){const t=await v.t;return await t.get("likesCache",re())||[]},o:async t=>(await v.t).put("likesCache",t,re()),async gt(){$t(await this.i())&&await this.o([])},async H(t){return(await this.i()).map((t=>t.id)).includes(t.id)}};function se(t){if(!t.id||!t.video||!t.author)return T(new Error(JSON.stringify(t)),"pid27","silently"),!1;if(!t.video.downloadAddr&&!t.video.playAddr)return T(new Error("no video addr"),"pid11","silently"),!1;if(!t.video.cover)return T(new Error("no cover"),"pid15","silently"),!1;if(t.id!==t.video.id)return T(new Error(`${t.id} different from ${t.video.id}`),"pid49","silently"),!1;if("mp4"!==t.video.format)return T(new Error(`video format is ${t.video.format}`),"pid56","silently"),!1;{const e=new URL(t.video.cover),i=e.searchParams.get("expire")||e.searchParams.get("x-expires");if(!i||10!==i.length)return T(new Error(`cover url no exp: ${t.video.cover}`),"pid100","silently"),!1}return!0}async function ae(){const t=await async function(){const t=[];let e="0",i=!0,n=0,r=0;await oe.gt();do{await U(1500);const o=new yt("likes").O(e).M(30);let s=[],a={};try{const t=await window.fetch(o.L(),{credentials:"include"});if(a=await t.json(),s=a.itemList,0!==a.statusCode){if("10000"===a.code&&"verify"===a.type)return T(new Error("need to solve recaptcha"),"fl39"),"error";throw new Error(`code: ${a.code} ${a.type}`)}}catch(t){if(n++,n<=3)continue;if(!a.cursor||a.cursor===e)return T(t,"fl53"),"error"}if(n=0,s){let e=s.map(ct);if(e.some((t=>!se(t)))&&(r++,r<=3))continue;if(r=0,e=s.filter(se),0===e.length&&s.length>10)return T(new Error("tiktok api changed, wait for the next patch of this extension to fix"),"fl76"),[];t.push(...e),b(9,{currentTotal:t.length})}if(0===t.length)return[];if(await oe.H(t[t.length-1]))break;if(({cursor:e,hasMore:i}=a),"-1"===String(e)||"0"===String(e)||!e){T(new Error(`weird cursor: ${e}`),"fl76","silently");break}}while(i);return t}();if("error"===t)return;const e=await oe.i(),i=Et(t.concat(e));await oe.o(i)}var ce,ue,le,he,de,fe,we,pe,ye;const me=new(ye=class{constructor(){ce.add(this),ue.set(this,[]),le.set(this,!1),he.set(this,0)}async kt(){N(this,le,!0,"f"),await U(1e3),gt.q.P("paused"),I.p()}async bt(){N(this,le,!1,"f")}async $t(){var t;await W(this,ce,"m",fe).call(this);try{if(0===W(this,ue,"f").length)return void b(10);if(!ot.C)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");I.l.likes.officialList=W(this,ue,"f").map((t=>t.id));const{finalDownloadOutcome:e}=await W(this,ce,"m",we).call(this);if("someUrlExpired"===e)return N(this,he,1+(t=+W(this,he,"f")),"f"),t>3?void T(new Error("Session too long, please reload"),"bl46"):void this.$t();W(this,ce,"m",pe).call(this,e)}catch(t){T(t,"bl50")}}},ue=new WeakMap,le=new WeakMap,he=new WeakMap,ce=new WeakSet,de=function(){return I.l.likes.downloaded.size>=ne()},fe=async function(){try{await ae(),I.l.likes.lastRun.collect=Date.now(),N(this,ue,await oe.i(),"f")}catch(t){throw T(t,"bl32"),t}},we=async function(){k(20,"likes"),gt.q.R({total:W(this,ue,"f").length,nowAt:0});for(const t of W(this,ue,"f")){new Ut(t,"liked").rt()}for(const[t,e]of W(this,ue,"f").reverse().entries()){const i=new Ut(e,"liked");if(!i.tt&&!i.et){if(W(this,ce,"m",de).call(this))return{finalDownloadOutcome:"capped"};for(;W(this,le,"f");)await U(1e3);if(i.it())return{finalDownloadOutcome:"someUrlExpired"};gt.q.P("downloading"),gt.q.R({total:W(this,ue,"f").length,nowAt:t+1}),i.nt().catch((t=>T(t,"bl75","silently"))),W(this,le,"f")||await U(O())}}return{finalDownloadOutcome:"completed"}},pe=async function(t){const e={officialListLength:I.l.likes.officialList.length,numMp4InLocalFolder:I.l.likes.downloaded.size,status:t};I.l.likes.lastRun.download=Date.now(),await U(200),b(12,e),gt.q.P(t),await I.p()},ye);function ve(t){b(6,t)}let _e=!1;var ge,ke,be,$e,Te,Ee;const Se=new(Ee=class{constructor(){ge.add(this),ke.set(this,null)}async Tt(){const t=await _.i("archiveFolderHandle"),e=await showDirectoryPicker({startIn:t});W(this,ge,"m",be).call(this,e)}Et(){b(5)}},ke=new WeakMap,ge=new WeakSet,be=async function(t){if("granted"!==await t.requestPermission({mode:"readwrite"}))return;if(!await async function(t){if(await async function(t){const e=[];for await(const i of t.keys())e.push(i);return 0===e.length}(t))return!!_e||(_e=!0,!ie._t.behavior.hasCreatedArchiveFolder||(ve({dropResult:"unexpectedly_empty"}),!1));try{await t.getFileHandle("Archive.html");const e=await t.getDirectoryHandle("data"),i=await e.getDirectoryHandle(".appdata");return await i.getFileHandle("app.js"),!0}catch(t){return ve({dropResult:"content_seems_wrong"}),!1}}(t))return;const e=await async function(t){const e=await E(t,"data/.appdata/db.js"),i=await e.getFile(),n=x(await i.text()),{id:r,uid:o,uniqueId:s,nickname:a}=ie._t.profile;return n.user.id.length>0&&n.user.id!==r?(ve({dropResult:"belongs_to_another_tiktok_account",belongsToUser:n.user.uniqueId}),null):(n.user={uid:o,id:r,uniqueId:s,nickname:a},n)}(t);e&&W(this,ge,"m",$e).call(this,t,e)},$e=async function(t,e){ot.C||$("is_resync_ready"),k(7),await I.h(t,e),await Mt.h(),"following"===gt.W?ee.wt():me.$t(),W(this,ge,"m",Te).call(this)},Te=function(){var t;null===(t=W(this,ke,"f"))||void 0===t||t.remove(),N(this,ke,null,"f")},Ee);const Ce={St:"unset",Ct:"unset",Dt:"unset",xt:"unset",It:-1,jt:-1,At:-1,Ot:0,Bt:0,Mt:0,Lt:0,Wt:0,Nt:!1,get Ut(){return this.It+this.jt+this.At+this.Ot+this.Bt+this.Mt+-10*this.Lt+this.Wt},i(){return this.Ut>=4?"us.tiktok.com":"m.tiktok.com"},async h(){var t,e;const{$domains:i,$region:n,$user:r}=lt.I;this.St=(null==i?void 0:i.mTApi)||"none",this.Ct=(null==i?void 0:i.rootApi)||"none",this.Dt=n,this.xt=(null==r?void 0:r.region)||"none","https://us.tiktok.com"===this.St&&(this.It=1),"https://us.tiktok.com"===this.Ct&&(this.jt=1),"us"===(null===(t=this.Dt)||void 0===t?void 0:t.toLowerCase())&&(this.At=1),"us"===(null===(e=this.xt)||void 0===e?void 0:e.toLowerCase())&&(this.Ot=1),1!==this.jt&&1!==this.It||this.St===this.Ct||T(new Error(`mTApi=${this.St} but rootApi=${this.Ct}`),"hn57","silently"),this.Ut>=3&&1!==this.jt&&T(new Error(`usIndicator hight but ${this.Ct} ${this.St}`),"hn86","silently"),this.Ut<3&&1===this.It&&T(new Error(`usIndicator low but ${this.Ct} ${this.St}`),"hn93","silently"),this.Dt!==this.xt&&"none"!==this.xt&&T(new Error(`region=${this.Dt} but userRegion=${this.xt}`),"hn76","silently"),!0===await _.i("captured_us_in_previous_sessions_")&&(this.Bt=1),3===this.Ut&&this.Ft()},async Ft(){try{const t=new yt("ping").O("0").M(30),e=await window.fetch(t.L(),{credentials:"include"}),i=await e.json();if(0!==i.statusCode)throw new Error(`statusCode: ${i.statusCode}`);if(!i.itemList)throw new Error(`no itemList: ${i}`);this.Wt=1}catch(t){T(t,"hn108","silently")}},qt:!1,Rt(t){const e=new URL(t.url).origin;this.qt||e!==this.St&&(T(new Error(`captured ${e} but mTApi=${this.St}`),"hn114","silently"),this.qt=!0)},Pt(t){try{if(t.startsWith("https://m.tiktok.com")){if(1===this.Lt)return;if(this.Lt=1,_.o("captured_us_in_previous_sessions_",!1),1===this.It||1===this.jt||1===this.At)throw new Error(`captured m but ${this.St} ${this.Ct} ${this.Dt} & ${this.xt}`)}else{if(!t.startsWith("https://us.tiktok.com"))throw new Error(`unexpected captured url: ${t} ${this.St} ${this.Ct} ${this.Dt} & ${this.xt}`);if(1===this.Mt&&1===this.Bt)return;if(this.Mt=1,this.Bt=1,_.o("captured_us_in_previous_sessions_",!0),1!==this.It||1!==this.jt||1!==this.At)throw new Error(`captured us but ${this.St} ${this.Ct} ${this.Dt} & ${this.xt}`)}}catch(t){this.Nt||(T(t,"hn147","silently"),this.Nt=!0)}}};function De(t){const{type:i,payload:n}=t.data;if("official_tiktok_likes"===i){const t=new yt("likes").O("0").M(30).L();e.postMessage({type:"compare",payload:{myUrl:t,officialUrl:n.officialUrl}})}if("official_tiktok_followed_authors"===i){const t=new yt("following").B({maxCursor:0,minCursor:0}).M(20).L();e.postMessage({type:"compare",payload:{myUrl:t,officialUrl:n.officialUrl}})}}function xe(){var i;null===(i=document.getElementById("myfaveTT-container"))||void 0===i||i.remove(),document.body.classList.remove("pushed-by-myfaveTT"),window.onmessage=null,t.onmessage=null,t.close(),e.onmessage=null,e.close()}let Ie="";async function je(e){try{const{type:i,payload:n}=e.data;if(0===i)return void t.postMessage({type:1});if(1===i)return xe(),void alert("Not loading myFaveTT sidebar, because it's already running in another tab.");if(100===i)return k(3,n),void jt.V();if(102===i)return void k(19,n);if(101===i){if(Ce.Rt(n),!Kt.st)return;if(Ie===(Ie=JSON.stringify(e.data)))return void console.error("double listener?!");try{const t=await async function(t){const{url:e,requestHeaders:i}=t,n=i.find((t=>"x-tt-params"===t.name));if(!n)return[];const r={[n.name]:n.value,Accept:"application/json, text/plain, text/csv, */*"};let o=0,s=0;for(;;){await U(1e3);const t=await fetch(e,{headers:r,credentials:"include"}),i=await t.json(),{statusCode:n,itemList:a}=i;if(0!==n){if(o++,o<=3)continue;return T(new Error(`Err in repeat captured request, ${JSON.stringify(i)}`),"bf31","silently"),[]}if(!a)return[];let c=a.map(ct);if(c.some((t=>!se(t)))){if(s++,s<=3)continue;T(new Error("still flawed"),"bf45","silently")}if(c=c.filter(se),a.length>10&&0===c.length)throw T(new Error(JSON.stringify(ct(a[0]))),"rp58","silently"),new Error("tiktok api changed, wait for the next patch of this extension to fix");return c}}(n);await Kt.lt(t)}catch(t){T(t,"om82","silently")}}}catch(t){T(t,"om41")}}async function Ae(e){try{const{origin:i,data:{type:n,payload:r}}=e;if(i!==g)return;switch(n){case"reload":location.href="https://www.tiktok.com";break;case"resync_is_ready":ot.C=!0;break;case"resynced":{const{tempStorageKey:t,arrayBuffer:e}=r;L.T(t,e);break}case 12:Se.Tt();break;case 1:try{gt.W="likes",I.u?me.$t():Se.Et()}catch(t){T(t,"om46")}break;case 2:try{gt.W="following",I.u?ee.wt():Se.Et()}catch(t){T(t,"om55")}break;case 3:xe();break;case 4:I.m(r);break;case 0:if(b(0,"1.2.67"),"initial"===lt.D){if(await lt.j(),"error"===lt.D)break;if(!lt.A())break;Ce.h()}b(4,ft()),function(e,i){t.postMessage({type:e,payload:i})}(2);break;case 5:me.kt();break;case 6:me.bt();break;case 10:Ft.ot=!0;break;case 11:Ft.ot=!1;break;case 7:ie.o(r);break;case 8:try{ee.yt(r)}catch(t){T(t,"om161")}break;case 9:At(r);break;case 13:location.href="https://www.tiktok.com";break;case 14:location.href="https://chrome.google.com/webstore/detail/myfavett/gmajiifkcmjkehmngbopoobeplhoegad";break;case 15:history.replaceState(null,"","/")}}catch(t){T(t,"om136")}}try{window.onmessage=Ae,t.onmessage=je,e.onmessage=De,t.postMessage({type:0})}catch(t){T(t,"st8")}
