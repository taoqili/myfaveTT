const t=new BroadcastChannel("myfaveTT");let e,n;const i=new WeakMap,r=new WeakMap,o=new WeakMap,a=new WeakMap,s=new WeakMap;let c={get(t,e,n){if(t instanceof IDBTransaction){if("done"===e)return r.get(t);if("objectStoreNames"===e)return t.objectStoreNames||o.get(t);if("store"===e)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set:(t,e,n)=>(t[e]=n,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function u(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(n||(n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(d(this),e),f(i.get(this))}:function(...e){return f(t.apply(d(this),e))}:function(e,...n){const i=t.call(d(this),e,...n);return o.set(i,e.sort?e.sort():[e]),f(i)}}function l(t){return"function"==typeof t?u(t):(t instanceof IDBTransaction&&function(t){if(r.has(t))return;const e=new Promise(((e,n)=>{const i=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",o),t.removeEventListener("abort",o)},r=()=>{e(),i()},o=()=>{n(t.error||new DOMException("AbortError","AbortError")),i()};t.addEventListener("complete",r),t.addEventListener("error",o),t.addEventListener("abort",o)}));r.set(t,e)}(t),n=t,(e||(e=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>n instanceof t))?new Proxy(t,c):t);var n}function f(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,n)=>{const i=()=>{t.removeEventListener("success",r),t.removeEventListener("error",o)},r=()=>{e(f(t.result)),i()},o=()=>{n(t.error),i()};t.addEventListener("success",r),t.addEventListener("error",o)}));return e.then((e=>{e instanceof IDBCursor&&i.set(e,t)})).catch((()=>{})),s.set(e,t),e}(t);if(a.has(t))return a.get(t);const e=l(t);return e!==t&&(a.set(t,e),s.set(e,t)),e}const d=t=>s.get(t);const h=["get","getKey","getAll","getAllKeys","count"],w=["put","add","delete","clear"],y=new Map;function p(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(y.get(e))return y.get(e);const n=e.replace(/FromIndex$/,""),i=e!==n,r=w.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!r&&!h.includes(n))return;const o=async function(t,...e){const o=this.transaction(t,r?"readwrite":"readonly");let a=o.store;return i&&(a=a.index(e.shift())),(await Promise.all([a[n](...e),r&&o.done]))[0]};return y.set(e,o),o}c=(t=>({...t,get:(e,n,i)=>p(e,n)||t.get(e,n,i),has:(e,n)=>!!p(e,n)||t.has(e,n)}))(c);const m={t:function(t,e,{blocked:n,upgrade:i,blocking:r,terminated:o}={}){const a=indexedDB.open(t,e),s=f(a);return i&&a.addEventListener("upgradeneeded",(t=>{i(f(a.result),t.oldVersion,t.newVersion,f(a.transaction))})),n&&a.addEventListener("blocked",(()=>n())),s.then((t=>{o&&t.addEventListener("close",(()=>o())),r&&t.addEventListener("versionchange",(()=>r()))})).catch((()=>{})),s}("myfaveTT",2,{upgrade(t,e,n,i){switch(e){case 0:t.createObjectStore("likesCache"),t.createObjectStore("followingCache");case 1:t.createObjectStore("misc")}}})},v={i:async t=>(await m.t).get("misc",t),o:async(t,e)=>(await m.t).put("misc",e,t)},g="chrome-extension://gmajiifkcmjkehmngbopoobeplhoegad";function k(t,e){ui.postMessage({type:t,payload:e},g)}const b=k;function _(t,e){ui.postMessage({type:t,payload:e},g)}function S(t,e,n){k(1,{err:t,location:e,silently:n})}async function T(t,e){try{const n=e.split("/"),i=n.pop();let r=t;for(const t of n)r=await r.getDirectoryHandle(t,{create:!0});return await r.getFileHandle(i,{create:!0})}catch(t){throw S(t,"gfh29"),t}}async function C(t,e){const n=await t.createWritable();await n.write(e),await n.close()}const D={schemaVersion:1,user:{uid:"",id:"",uniqueId:"",nickname:""},authors:{},videos:{},likes:{downloadStatus:"unset",officialList:[],downloaded:new Set,lastRun:{collect:0,download:0}},following:{officialAuthorList:new Set,started:new Set,notInterested:new Set,downloadLog:{},lastRun:{}}};function I(t){return e=function(t){return JSON.stringify(t,(function(t,e){return e instanceof Set?[...e]:"string"==typeof e?e.replaceAll("`","èƒŒð“„¹å‰ƒ").replaceAll("${","â‘€â¦ƒ"):e}))}(t),"db=String.raw`{}`;".slice(0,"db=String.raw`{}`;".indexOf("{"))+e+"db=String.raw`{}`;".slice("db=String.raw`{}`;".lastIndexOf("}")+1);var e}function x(t){return""===t?D:function(t){const e=JSON.parse(t,(function(t,e){switch(t){case"downloaded":case"notInterested":case"started":case"officialAuthorList":if(Array.isArray(e))return new Set(e)}return"string"==typeof e?e.replaceAll("â‘€â¦ƒ","${").replaceAll("èƒŒð“„¹å‰ƒ","`"):e}));for(const[t,n]of Object.entries(e.following.downloadLog))e.following.downloadLog[t]=new Set(n);return e}(function(t){const e=t.indexOf("{"),n=t.lastIndexOf("}")-t.length+1;return t.slice(e,n)}(t))}const E=new class{constructor(){this.u=null,this.l=null}async h(t,e){this.u=t,this.l=e,k(8),v.o("archiveFolderHandle",t)}async p(){try{C(await T(this.u,"data/.appdata/db.js"),I(this.l))}catch(t){S(t,"a42")}}async m(t){try{const{archiveHtml:e,appJs:n}=t;C(await T(this.u,"Archive.html"),e),C(await T(this.u,"data/.appdata/app.js"),n)}catch(t){S(t,"a58")}}v(t){t.forEach((t=>{const{id:e,uniqueId:n,nickname:i,signature:r}=t.user,{followerCount:o,videoCount:a,heartCount:s}=t.stats,c={uniqueIds:[n],nicknames:[i],followerCount:o,heartCount:s,videoCount:a,signature:r},u=this.l.authors[e];u&&(c.uniqueIds=[...new Set([n,...u.uniqueIds])],c.nicknames=[...new Set([i,...u.nicknames])]),this.l.authors[e]=c})),this.l.following.officialAuthorList=new Set(t.map((t=>t.user.id))),this.p()}async g(t){try{if(!this.l.following.started.has(t)&&!this.l.following.downloadLog[t])return;this.l.following.started.delete(t),delete this.l.following.downloadLog[t],await this.p();let e=await this.u.getDirectoryHandle("data");e=await e.getDirectoryHandle("Following"),e=await e.getDirectoryHandle(t),await e.removeEntry("videos",{recursive:!0})}catch(t){S(t,"purge failed","silently")}}},$={k(t,e){k(2,{event:t,params:e})}};const j={};async function O(){const t=[];Object.entries(j).forEach((async([e,n])=>{const{createTime:i,cover:r,video:o}=n;if(Boolean(r&&o))t.push(async function(t){var e;const{startWritingToDiskTime:n,key:i,likedOrFollowing:r,itemData:{id:o,author:a},cover:s,video:c,size:u}=t;if(0!==n){return Date.now()-n<1e4?void 0:(delete j[i],void $.k("stuck in writing"))}t.startWritingToDiskTime=Date.now();try{const t="liked"===r?"data/Likes":`data/Following/${a.id}`,n=`${t}/covers/${o}.jpg`,l=`${t}/videos/${o}.mp4`,f=T(E.u,n).then((t=>C(t,s))),d=T(E.u,l).then((t=>C(t,c)));if(await Promise.all([f,d]),E.l.videos[o].size=u,"following"===r){const t=E.l.following.downloadLog;t[e=a.id]||(t[e]=new Set),t[a.id].add(o)}else E.l.likes.downloaded.add(o)}catch(t){S(t,"ts71","silently")}finally{delete j[i],Object.keys(j).length}}(n));else{Date.now()-i>6e4&&(delete j[e],$.k("took over 30 seconds"))}})),t.length&&(await Promise.allSettled(t),await E.p())}const A=new class{addNew(t){j[t.key]=t}_(t,e){j[t]&&(j[t].cover=e,O())}S(t,e){j[t]&&(j[t].size=e)}T(t,e){j[t]&&(j[t].video=e,O())}};function B(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)}function M(t,e,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(t,n):r?r.value=n:e.set(t,n),n}function W(t){return new Promise((e=>{setTimeout((()=>{e(t)}),t)}))}function N(t){const e=5e3,n={unlocked:["unlock_0_to_1000_likes_(free)"],cap:1e3,nextToBuy:"unlock_1001_to_5000_likes",lineItemDescription:'"Enable downloading more than 1000, up to 5000 videos from your Likes on TikTok."'};if(0===t)return n;const i=[n.unlocked[0]],r=e*t,o=r+e,a=`unlock_${r+1}_to_${o}_likes`,s=`"Enable downloading more than ${r}, up to ${o} videos from your Likes on TikTok."`;for(let e=0;e<t;e++)i.push(N(e)?.nextToBuy);return{unlocked:i,cap:r,nextToBuy:a,lineItemDescription:s}}const L=/^\s+|\s+$/g,F=/^[-+]0x[0-9a-f]+$/i,q=/^0b[01]+$/i,P=/^0o[0-7]+$/i,U=parseInt,R="object"==typeof global&&global&&global.Object===Object&&global,J="object"==typeof self&&self&&self.Object===Object&&self,H=R||J||Function("return this")(),K=Object.prototype.toString,z=Math.max,V=Math.min,G=function(){return H.Date.now()};function Q(t,e,n){let i,r,o,a,s,c,u=0,l=!1,f=!1,d=!0;if("function"!=typeof t)throw new TypeError("Expected a function");function h(e){const n=i,o=r;return i=r=void 0,u=e,a=t.apply(o,n),a}function w(t){return u=t,s=setTimeout(p,e),l?h(t):a}function y(t){const n=t-c;return void 0===c||n>=e||n<0||f&&t-u>=o}function p(){const t=G();if(y(t))return m(t);s=setTimeout(p,function(t){const n=e-(t-c);return f?V(n,o-(t-u)):n}(t))}function m(t){return s=void 0,d&&i?h(t):(i=r=void 0,a)}function v(){const t=G(),n=y(t);if(i=arguments,r=this,c=t,n){if(void 0===s)return w(c);if(f)return s=setTimeout(p,e),h(c)}return void 0===s&&(s=setTimeout(p,e)),a}return e=Y(e)||0,X(n)&&(l=!!n.leading,f="maxWait"in n,o=f?z(Y(n.maxWait)||0,e):o,d="trailing"in n?!!n.trailing:d),v.cancel=function(){void 0!==s&&clearTimeout(s),u=0,i=c=r=s=void 0},v.flush=function(){return void 0===s?a:m(G())},v}function X(t){const e=typeof t;return!!t&&("object"==e||"function"==e)}function Y(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&"[object Symbol]"==K.call(t)}(t))return NaN;if(X(t)){const e="function"==typeof t.valueOf?t.valueOf():t;t=X(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(L,"");const e=q.test(t);return e||P.test(t)?U(t.slice(2),e?2:8):F.test(t)?NaN:+t}const Z={};const tt=function(t,e,n){let i=!0,r=!0;if("function"!=typeof t)throw new TypeError("Expected a function");return X(n)&&(i="leading"in n?!!n.leading:i,r="trailing"in n?!!n.trailing:r),Q(t,e,{leading:i,maxWait:e,trailing:r})}((function(){Object.entries(Z).forEach((async([t,e])=>{const n=await T(E.u,`data/Following/Avatars/${t}`),i=await n.createWritable();await i.write(e),await i.close(),delete Z[t]}))}),7e3);async function et(t,e){const n=await T(E.u,`data/Following/Avatars/${e}`),i=await n.getFile();if(i.size>0){const t=12096e5;if(Date.now()-i.lastModified<t)return}const r=await fetch(t),o=r.headers.get("Content-Type");if("image/jpeg"!==o)return void S(new Error(`avatar type is ${o}`),"daa9","silently");const a=await r.blob();Z[e]=a,tt(),e.includes("small")&&await W(200),e.includes("large")&&await W(2e3)}const nt={C:!1},it=t=>e=>{const n={};for(const i of t)n[i]=e[i];return n},rt=t=>e=>{const n={};return e.forEach((e=>{n[e[t]]=e})),n};function ot(t){const e=it(["id","desc","createTime","itemMute"])(t);return e.video=it(["id","cover","playAddr","downloadAddr","format"])(t.video),e.stats=it(["diggCount","playCount"])(t.stats),e.author=it(["id","uniqueId","nickname","avatarLarger"])(t.author),e.authorStats=it(["followerCount","heartCount","videoCount"])(t.authorStats),e}function at(t){return it(["id","uniqueId","nickname","avatarLarger","avatarThumb","signature"])(t.user)}const st=new class{constructor(){this.D="initial",this.I={}}async $(){if(window.__NEXT_DATA__)try{this.I=window.__NEXT_DATA__.props.initialProps,this.D="next"}catch(t){S(t,"ac26"),this.D="error"}else if(window.SIGI_STATE)try{this.I=window.SIGI_STATE.AppContext.appContext,this.D="sigi"}catch(t){S(t,"ac37"),this.D="error"}else try{const t=await fetch("/node-webapp/api/app-context"),e=await t.json();0===e.statusCode?(this.I=e,this.D="fetched"):(S(new Error(e),"ac49"),this.D="error")}catch(t){S(t,"ac52"),this.D="error"}$.k("app_context",{status:this.D}),this.D}j(){const{$wid:t,$region:e,$os:n,$language:i,$user:r}=this.I;if(!(t&&e&&n&&i))return S(new Error(JSON.stringify({$wid:t,$region:e,$os:n,$language:i})),"ac64"),!1;if(!r)return!0;const{uid:o,uniqueId:a,secUid:s,nickName:c}=r;return!!(o&&a&&s&&c)||(S(new Error(JSON.stringify({uid:o,uniqueId:a,secUid:s,nickName:c})),"ac75"),!1)}};var ct,ut,lt;class ft{constructor(t){return ct.add(this),ut.set(this,void 0),M(this,ut,"likes"===t?new URL("https://m.tiktok.com/api/favorite/item_list/"):new URL("https://m.tiktok.com/api/user/list/"),"f"),B(this,ct,"m",lt).call(this),this}O(t){return B(this,ut,"f").searchParams.set("cursor",t),this}A({maxCursor:t,minCursor:e}){return B(this,ut,"f").searchParams.set("maxCursor",String(t)),B(this,ut,"f").searchParams.set("minCursor",String(e)),this}B(t){return B(this,ut,"f").searchParams.set("count",String(t)),this}M(){return B(this,ut,"f").toString()}}ut=new WeakMap,ct=new WeakSet,lt=function(){const t=Object.assign({},function(){var t;return{aid:"1988",app_name:"tiktok_web",device_platform:"web_pc",referer:document.referrer,cookie_enabled:navigator.cookieEnabled,screen_width:screen.width,screen_height:screen.height,browser_language:navigator.language,browser_platform:navigator.platform,browser_name:navigator.appCodeName,browser_version:navigator.appVersion,browser_online:navigator.onLine,verifyFp:null===(t=document.cookie.match(/s_v_web_id=(\w+)/))||void 0===t?void 0:t[1],timezone_name:Intl.DateTimeFormat().resolvedOptions().timeZone,is_page_visible:!0,focus_state:!0,is_fullscreen:window.matchMedia("(display-mode: fullscreen)").matches,history_len:window.history.length,battery_info:{}}}(),function(){const{$wid:t,$region:e,$language:n,$os:i,$user:r}=st.I;return{device_id:t,region:e,priority_region:r.region,os:i,app_language:n,secUid:r.secUid,language:n}}());Object.entries(t).forEach((([t,e])=>{B(this,ut,"f").searchParams.set(t,(null==e?void 0:e.toString())||"")}))};const dt=1030,ht=["unset","downloading","paused","capped","completed"],wt=["downloading","completed","capped","pausing","paused","resuming"],yt={W:"unset",N:{L(t){k(16,t)},F(t){k(17,t)}},q:{P(t){b(11,{progress:t})},U(t){wt.includes(t)&&b(11,{status:t}),ht.includes(t)&&(E.l.likes.downloadStatus=t)}}};function pt(t){if(!t)return!1;const e=new URL(t),n=e.searchParams.get("expire")||e.searchParams.get("x-expires");if(!n)return!1;return(Number(n+"000")-Date.now())/1e3/60<30}function mt(t){return[t.video.playAddr,t.video.cover].some(pt)}function vt(t){return t.some(mt)}function gt(t){return{async R(){const e=await m.t,n=await e.get("followingCache",t);return n?vt(n)?[]:n.sort(((t,e)=>t.createTime-e.createTime)):[]},o:async e=>(await m.t).put("followingCache",e,t),async J(t){return(await this.R()).map((t=>t.id)).includes(t.id)}}}function kt(t){const e=rt("id")(t),n=t.map((t=>t.id));return[...new Set(n)].map((t=>e[t]))}var bt,_t,St,Tt,Ct;const Dt=new(Ct=class{constructor(){bt.add(this),this.D="unset",_t.set(this,"unset")}async H(){try{if(this.D===(this.D="expanding"))return;const t=await B(this,bt,"m",St).call(this);if(!t)return S(new Error("cannot find authorList"),"ale63","silently"),b(21),void(this.D="failed");if("A"===t.lastChild.tagName)return void(this.D="expanded");if("unset"===B(this,_t,"f"))return M(this,_t,t.lastChild.textContent,"f"),B(this,_t,"f"),void B(this,bt,"m",Tt).call(this,t);if(B(this,_t,"f")===t.lastChild.textContent)return void B(this,bt,"m",Tt).call(this,t);if(t.lastChild.textContent!==B(this,_t,"f"))return void(this.D="expanded")}catch(t){S(t,"ale92")}}},_t=new WeakMap,bt=new WeakSet,St=async function(){let t=document.querySelectorAll(".user-list");0===t.length&&(t=document.querySelectorAll('div[class*="-DivUserContainer"]'));let e=t[t.length-1];if(!e){const n=document.querySelector('a[title="TikTok"]');n&&(n.click(),await W(3e3),t=document.querySelectorAll(".user-list"),0===t.length&&(t=document.querySelectorAll('div[class*="-DivUserContainer"]')),e=t[t.length-1])}return e},Tt=async function(t){for(var e,n;;){if(null===(e=t.lastChild)||void 0===e||e.click(),await W(2e3),"A"===t.lastChild.tagName)return void(this.D="expanded");if((null===(n=t.lastChild)||void 0===n?void 0:n.textContent)!==B(this,_t,"f"))return void(this.D="expanded")}},Ct);async function It(t){for(Dt.H();;){const e=document.querySelector(`a[href*="${t}"]`);if(e)return void e.click();if("expanded"===Dt.D)return void S(new Error("Couldn't find the author to click on the left bar. Maybe you just added a new follow. Reload and try again."),"sa22");await W(500)}}var xt,Et,$t;class jt{constructor(t,e){this.K=t,this.V=e,xt.add(this),this.G=this.K.id+this.V}get X(){var t;return"liked"===this.V?Boolean(E.l.likes.downloaded.has(this.K.id)):Boolean(null===(t=E.l.following.downloadLog[this.K.author.id])||void 0===t?void 0:t.has(this.K.id))}Y(){return mt(this.K)}async Z(){A.addNew({createTime:Date.now(),startWritingToDiskTime:0,key:this.G,likedOrFollowing:this.V,itemData:this.K}),await B(this,xt,"m",Et).call(this),await B(this,xt,"m",$t).call(this)}tt(){try{E.l.videos[this.K.id]=function(t,e){const n={authorId:t.author.id,desc:t.desc,createTime:t.createTime,itemMute:t.itemMute,diggCount:t.stats.diggCount,playCount:t.stats.playCount},i=e.videos[t.id];return Object.assign({},i,n)}(this.K,E.l),E.l.authors[this.K.author.id]=function(t,e){const n={uniqueIds:[t.author.uniqueId],nicknames:[t.author.nickname],followerCount:t.authorStats.followerCount,heartCount:t.authorStats.heartCount,videoCount:t.authorStats.videoCount},i=e.authors[t.author.id];i&&(n.uniqueIds=[...new Set([...n.uniqueIds,...i.uniqueIds])],n.nicknames=[...new Set([...n.nicknames,...i.nicknames])]);return Object.assign({},i,n)}(this.K,E.l)}catch(t){S(t,"i77")}}}xt=new WeakSet,Et=async function(){try{const t=await fetch(this.K.video.cover),e=t.headers.get("Content-Type");if("image/jpeg"!==e)throw new Error(`cover type is ${e}`);const n=await t.arrayBuffer();A._(this.G,n)}catch(t){"Failed to fetch"===t.message?S(new Error(`fetch failed ${this.K.video.cover}`),"bi60","silently"):S(t,"bi63","silently")}},$t=async function(){try{const t=await fetch(this.K.video.playAddr||this.K.video.downloadAddr),e=t.headers.get("Content-Type");if("video/mp4"!==e)throw new Error(`video type is ${e}`);const n=t.headers.get("Content-Length");A.S(this.G,(Number(n)/1024/1024).toFixed(1)+"MB");const i=await t.arrayBuffer();_("please_resync_this_video",{tempStorageKey:this.G,arrayBuffer:i})}catch(t){"Failed to fetch"===t.message?S(new Error(`fetch failed ${this.K.video.playAddr||this.K.video.downloadAddr}`),"bi105","silently"):S(t,"bi108","silently")}};const Ot={et:!1};var At,Bt,Mt,Wt,Nt,Lt,Ft;const qt=new(Ft=class{constructor(){At.add(this),Bt.set(this,[]),this.nt="",Mt.set(this,null)}async it(t,e){try{this.nt=t,M(this,Bt,[],"f"),document.documentElement.style.overflow="hidden",document.documentElement.style.pointerEvents="none",document.querySelector("aside#myfaveTT-container").style.pointerEvents="auto",await It(e),await W(2e3),B(this,At,"m",Wt).call(this)}catch(t){S(t,"sr48")}}async rt(t){if(0===t.length)return void S(new Error("repeat failed?"),"scr78","silently");const e=function(t){const e=t[0].author.id;if(t.some((t=>t.author.id!==e)))throw new Error("not all videos share the same author");return e}(t);if(e!==this.nt)return;if(vt(B(this,Bt,"f")))return B(this,At,"m",Lt).call(this),zt.ot(e),void(this.nt="");B(this,Bt,"f").push(...t),yt.N.L(B(this,Bt,"f").length);if(!await gt(e).J(B(this,Bt,"f")[B(this,Bt,"f").length-1]))return B(this,Bt,"f").length>dt?(M(this,Bt,B(this,Bt,"f").slice(0,dt),"f"),void await this.at()):void 0;await this.at()}async at(){var t;try{if(!this.nt)return;const e=this.nt;this.nt="",B(this,At,"m",Lt).call(this);const n=await gt(e).R(),i=kt(B(this,Bt,"f").concat(n));await gt(e).o(i),i.length,(t=E.l.following.lastRun)[e]||(t[e]={scroll:0,download:0}),E.l.following.lastRun[e].scroll=Date.now(),E.p(),async function(t){E.l.following.started.add(t);const e=await gt(t).R();for(const[n,i]of e.entries()){for(;Ot.et;)await W(500);const r=new jt(i,"following");if(r.tt(),!r.X){if(r.Y())return void zt.ot(t);yt.N.F({total:e.length,current:n+1}),r.Z().catch((t=>S(t,"doa22","silently"))),await W(6e3)}}E.l.following.lastRun[t].download=Date.now(),await W(2e3),await zt.ot(t)}(e)}catch(t){S(t,"blf73")}}},Bt=new WeakMap,Mt=new WeakMap,At=new WeakSet,Wt=function(){B(this,Mt,"f")&&clearInterval(B(this,Mt,"f")),M(this,Mt,setInterval((()=>B(this,At,"m",Nt).call(this)),2e3),"f")},Nt=async function(){try{if("hidden"===document.visibilityState)return;if(!this.nt)return;!function(){const{scrollHeight:t,scrollTop:e,clientHeight:n}=document.documentElement;return t-e-n<20}()?window.scrollBy(0,window.innerHeight):(await W(2e3),await this.at())}catch(t){S(t,"fl58")}},Lt=function(){clearInterval(B(this,Mt,"f"))},Ft);var Pt,Ut,Rt,Jt,Ht,Kt;const zt=new(Kt=class{constructor(){Pt.add(this),this.st={},this.ct={alreadyInArchive:[],willAddToArchive:[],notInterested:[]},Ut.set(this,[])}async ut(){try{const t=await async function(){let t=[],[e,n]=[0,0],i=0;do{await W(1e3);const r=new ft("following").A({maxCursor:e,minCursor:n}).B(0===e?10:20);try{const i=await window.fetch(r.M(),{credentials:"include"}),o=await i.json(),{statusCode:a,userList:s}=o;if(0!==a)throw new Error(`Err fetching authors, ${JSON.stringify(o)}`);if(t=(s||[]).concat(t),({maxCursor:e,minCursor:n}=o),b(13,{currentTotal:t.length}),"number"!=typeof e||"number"!=typeof n)throw new Error("Things have changed? Author cursor is no longer number?")}catch(e){if(i++,i<=3)continue;return S(e,"fa43"),t}if(i=0,0===t.length)return[]}while("-1"!==String(e)&&"-1"!==String(n));return t}();if(!nt.C)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");E.v(t),async function(t){for(const e of t){const{id:t,avatarThumb:n}=e.user;try{await et(n,`small_${t}.jpg`)}catch(t){S(t,"daa60","silently")}}for(const e of t){const{id:t,avatarLarger:n}=e.user;try{await et(n,`large_${t}.jpg`)}catch(t){S(t,"daa68","silently")}}}(t);const e=t.map(at);this.st=rt("id")(e),k(14,{authorDict:this.st,started:[...E.l.following.started],notInterested:[...E.l.following.notInterested]})}catch(t){S(t,"ff27")}}async lt(t){k(20,"following"),this.ct=t,E.l.following.notInterested=new Set(t.notInterested);const e=[...t.willAddToArchive,...t.alreadyInArchive].sort(((t,e)=>{var n,i;return((null===(n=E.l.following.lastRun[t])||void 0===n?void 0:n.download)||0)-((null===(i=E.l.following.lastRun[e])||void 0===i?void 0:i.download)||0)}));M(this,Ut,e.map((t=>({authorId:t,status:"queued"}))),"f"),await E.p(),await B(this,Pt,"m",Rt).call(this),await B(this,Pt,"m",Jt).call(this)}async ot(t){try{const e=B(this,Ut,"f").find((e=>e.authorId===t));e&&(e.status="finished"),await E.p(),await B(this,Pt,"m",Jt).call(this)}catch(t){S(t,"ff101")}}},Ut=new WeakMap,Pt=new WeakSet,Rt=async function(){for(const t of E.l.following.officialAuthorList)this.ct.alreadyInArchive.includes(t)||this.ct.willAddToArchive.includes(t)||await E.g(t)},Jt=async function(){const t=B(this,Ut,"f").find((t=>"queued"===t.status));if(t){t.status="current";const e=this.st[t.authorId].uniqueId;await qt.it(t.authorId,e),k(15,B(this,Ut,"f"))}else B(this,Pt,"m",Ht).call(this)},Ht=function(){const{officialAuthorList:t,started:e,notInterested:n}=E.l.following;k(18,{numFollowed:t.size,numStarted:e.size,numNotInterested:n.size,numCappedOut:[...t].filter((t=>!e.has(t))).filter((t=>!n.has(t))).length})},Kt),Vt=new class{constructor(){this.ft={}}o(t){this.ft=t}};function Gt(){try{return N(Vt.ft.unlocks.likeLevel).cap}catch(t){return S(t,"ud17"),0}}function Qt(){return Vt.ft.profile.uid}const Xt={async i(){const t=await m.t;return await t.get("likesCache",Qt())||[]},o:async t=>(await m.t).put("likesCache",t,Qt()),async dt(){vt(await this.i())&&await this.o([])},async J(t){return(await this.i()).map((t=>t.id)).includes(t.id)}};function Yt(t){if(!t.id||!t.video||!t.author)return S(new Error(JSON.stringify(t)),"pid27","silently"),!1;if(!t.video.downloadAddr&&!t.video.playAddr)return S(new Error("no video addr"),"pid11","silently"),!1;if(!t.video.cover)return S(new Error(JSON.stringify(t.video)),"pid39","silently"),!1;if(t.id!==t.video.id)return S(new Error(`${t.id} different from ${t.video.id}`),"pid49","silently"),!1;if("mp4"!==t.video.format)return S(new Error(`video format is ${t.video.format}`),"pid56","silently"),!1;if(!t.video.cover.includes("tiktokcdn"))return S(new Error(`Cover url not in tiktokcdn: ${t.video.cover}`),"pid79","silently"),!1;{const e=new URL(t.video.cover),n=e.searchParams.get("expire")||e.searchParams.get("x-expires");if(!n||10!==n.length)return S(new Error(`cover url no exp: ${t.video.cover}`),"pid100","silently"),!1}return!0}async function Zt(){const t=await async function(){const t=[];let e="0",n=!0,i=0,r=0;await Xt.dt();do{await W(1e3);const o=new ft("likes").O(e).B(30);let a=[],s={};try{const t=await window.fetch(o.M(),{credentials:"include"});if(s=await t.json(),a=s.itemList,0!==s.statusCode)throw new Error(`status_code: ${s.statusCode}`)}catch(t){if(i++,i<=3)continue;if(!s.cursor||s.cursor===e)return S(t,"fl53"),"error"}if(i=0,a){let e=a.map(ot);if(e.some((t=>!Yt(t)))&&(r++,r<=3))continue;if(r=0,e=a.filter(Yt),0===e.length&&a.length>10)return S(new Error("tiktok api changed, wait for the next patch of this extension to fix"),"fl76"),[];t.push(...e),b(9,{currentTotal:t.length})}if(0===t.length)return[];if(await Xt.J(t[t.length-1]))break;if(({cursor:e,hasMore:n}=s),"-1"===String(e)||"0"===String(e)||!e){S(new Error(`weird cursor: ${e}`),"fl76","silently");break}}while(n);return t}();if("error"===t)return;const e=await Xt.i(),n=kt(t.concat(e));await Xt.o(n)}var te,ee,ne,ie,re,oe,ae,se,ce;const ue=new(ce=class{constructor(){te.add(this),ee.set(this,[]),ne.set(this,!1),ie.set(this,0)}async ht(){M(this,ne,!0,"f"),await W(1e3),yt.q.U("paused"),E.p()}async wt(){M(this,ne,!1,"f")}async yt(){var t;await B(this,te,"m",oe).call(this);try{if(0===B(this,ee,"f").length)return void b(10);if(!nt.C)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");E.l.likes.officialList=B(this,ee,"f").map((t=>t.id));const{finalDownloadOutcome:e}=await B(this,te,"m",ae).call(this);if("someUrlExpired"===e)return M(this,ie,1+(t=+B(this,ie,"f")),"f"),t>3?void S(new Error("Session too long, please reload"),"bl46"):void this.yt();B(this,te,"m",se).call(this,e)}catch(t){S(t,"bl50")}}},ee=new WeakMap,ne=new WeakMap,ie=new WeakMap,te=new WeakSet,re=function(){return E.l.likes.downloaded.size>=Gt()},oe=async function(){try{await Zt(),E.l.likes.lastRun.collect=Date.now(),M(this,ee,await Xt.i(),"f")}catch(t){throw S(t,"bl32"),t}},ae=async function(){k(20,"likes"),yt.q.P({total:B(this,ee,"f").length,nowAt:0});for(const t of B(this,ee,"f")){new jt(t,"liked").tt()}for(const[t,e]of B(this,ee,"f").reverse().entries()){const n=new jt(e,"liked");if(!n.X){if(B(this,te,"m",re).call(this))return{finalDownloadOutcome:"capped"};for(;B(this,ne,"f");)await W(1e3);if(n.Y())return{finalDownloadOutcome:"someUrlExpired"};yt.q.U("downloading"),yt.q.P({total:B(this,ee,"f").length,nowAt:t+1}),n.Z().catch((t=>S(t,"bl75","silently"))),B(this,ne,"f")||await W(6e3)}}return{finalDownloadOutcome:"completed"}},se=async function(t){const e={officialListLength:E.l.likes.officialList.length,numMp4InLocalFolder:E.l.likes.downloaded.size,status:t};E.l.likes.lastRun.download=Date.now(),await W(200),b(12,e),yt.q.U(t),await E.p()},ce);function le(t){b(6,t)}let fe=!1;var de,he,we,ye,pe,me;const ve=new(me=class{constructor(){de.add(this),he.set(this,null)}async vt(){const t=await v.i("archiveFolderHandle"),e=await showDirectoryPicker({startIn:t});B(this,de,"m",we).call(this,e)}gt(){b(5)}},he=new WeakMap,de=new WeakSet,we=async function(t){if("granted"!==await t.requestPermission({mode:"readwrite"}))return;if(!await async function(t){if(await async function(t){const e=[];for await(const n of t.keys())e.push(n);return 0===e.length}(t))return!!fe||(fe=!0,!Vt.ft.behavior.hasCreatedArchiveFolder||(le({dropResult:"unexpectedly_empty"}),!1));try{await t.getFileHandle("Archive.html");const e=await t.getDirectoryHandle("data"),n=await e.getDirectoryHandle(".appdata");return await n.getFileHandle("app.js"),!0}catch(t){return le({dropResult:"content_seems_wrong"}),!1}}(t))return;const e=await async function(t){const e=await T(t,"data/.appdata/db.js"),n=await e.getFile(),i=x(await n.text()),{id:r,uid:o,uniqueId:a,nickname:s}=Vt.ft.profile;return i.user.id.length>0&&i.user.id!==r?(le({dropResult:"belongs_to_another_tiktok_account",belongsToUser:i.user.uniqueId}),null):(i.user={uid:o,id:r,uniqueId:a,nickname:s},i)}(t);e&&B(this,de,"m",ye).call(this,t,e)},ye=async function(t,e){nt.C||_("is_resync_ready"),k(7),await E.h(t,e),"following"===yt.W?zt.ut():ue.yt(),B(this,de,"m",pe).call(this)},pe=function(){var t;null===(t=B(this,he,"f"))||void 0===t||t.remove(),M(this,he,null,"f")},me);function ge(){var e;null===(e=document.getElementById("myfaveTT-container"))||void 0===e||e.remove(),document.body.classList.remove("pushed-by-myfaveTT"),t.onmessage=null,t.close(),window.removeEventListener("message",_e)}let ke="";async function be(e){try{const{type:n,payload:i}=e.data;if(0===n)return void t.postMessage({type:1});if(1===n)return ge(),void alert("Not loading myFaveTT sidebar, because it's already running in another tab.");if(100===n)return k(3,i),void Dt.H();if(102===n)return void k(19,i);if(101===n){if(!qt.nt)return;if(ke===(ke=JSON.stringify(e.data)))return void console.error("double listener?!");try{const t=await async function(t){const{url:e,requestHeaders:n}=t,i=n.find((t=>"x-tt-params"===t.name));if(!i)return[];const r={[i.name]:i.value,Accept:"application/json, text/plain, text/csv, */*"};let o=0,a=0;for(;;){await W(1e3);const t=await fetch(e,{headers:r,credentials:"include"}),n=await t.json(),{statusCode:i,itemList:s}=n;if(0!==i){if(o++,o<=3)continue;return S(new Error(`Err in repeat captured request, ${JSON.stringify(n)}`),"bf31","silently"),[]}if(!s)return[];let c=s.map(ot);if(c.some((t=>!Yt(t)))){if(a++,a<=3)continue;S(new Error("still flawed"),"bf45","silently")}if(c=c.filter(Yt),s.length>10&&0===c.length)throw S(new Error(JSON.stringify(ot(s[0]))),"rp58","silently"),new Error("tiktok api changed, wait for the next patch of this extension to fix");return c}}(i);await qt.rt(t)}catch(t){S(t,"om82","silently")}}}catch(t){S(t,"om41")}}async function _e(e){try{const{origin:n,data:{type:i,payload:r}}=e;if(n!==g)return;switch(i){case"reload":location.href="https://www.tiktok.com";break;case"resync_is_ready":nt.C=!0;break;case"resynced":{const{tempStorageKey:t,arrayBuffer:e}=r;A.T(t,e);break}case 12:ve.vt();break;case 1:try{yt.W="likes",E.u?ue.yt():ve.gt()}catch(t){S(t,"om46")}break;case 2:try{yt.W="following",E.u?zt.ut():ve.gt()}catch(t){S(t,"om55")}break;case 3:ge();break;case 4:E.m(r);break;case 0:if(b(0,"1.2.35"),"initial"===st.D){if(await st.$(),"error"===st.D)break;if(!st.j())break}b(4,function(){const t=st.I.$user;return{id:(null==t?void 0:t.uid)||null,secUid:(null==t?void 0:t.secUid)||null,uniqueId:(null==t?void 0:t.uniqueId)||null,nickname:(null==t?void 0:t.nickName)||null}}()),function(e,n){t.postMessage({type:e,payload:n})}(2);break;case 5:ue.ht();break;case 6:ue.wt();break;case 10:Ot.et=!0;break;case 11:Ot.et=!1;break;case 7:Vt.o(r);break;case 8:try{zt.lt(r)}catch(t){S(t,"om161")}break;case 9:It(r)}}catch(t){S(t,"om136")}}try{t.onmessage=be,window.removeEventListener("message",_e),window.addEventListener("message",_e),t.postMessage({type:0})}catch(t){S(t,"st8")}
