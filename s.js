const t=new BroadcastChannel("myfaveTT");let e,i;const n=new WeakMap,r=new WeakMap,o=new WeakMap,a=new WeakMap,s=new WeakMap;let c={get(t,e,i){if(t instanceof IDBTransaction){if("done"===e)return r.get(t);if("objectStoreNames"===e)return t.objectStoreNames||o.get(t);if("store"===e)return i.objectStoreNames[1]?void 0:i.objectStore(i.objectStoreNames[0])}return u(t[e])},set:(t,e,i)=>(t[e]=i,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function l(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(i||(i=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(f(this),e),u(n.get(this))}:function(...e){return u(t.apply(f(this),e))}:function(e,...i){const n=t.call(f(this),e,...i);return o.set(n,e.sort?e.sort():[e]),u(n)}}function d(t){return"function"==typeof t?l(t):(t instanceof IDBTransaction&&function(t){if(r.has(t))return;const e=new Promise(((e,i)=>{const n=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",o),t.removeEventListener("abort",o)},r=()=>{e(),n()},o=()=>{i(t.error||new DOMException("AbortError","AbortError")),n()};t.addEventListener("complete",r),t.addEventListener("error",o),t.addEventListener("abort",o)}));r.set(t,e)}(t),i=t,(e||(e=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>i instanceof t))?new Proxy(t,c):t);var i}function u(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,i)=>{const n=()=>{t.removeEventListener("success",r),t.removeEventListener("error",o)},r=()=>{e(u(t.result)),n()},o=()=>{i(t.error),n()};t.addEventListener("success",r),t.addEventListener("error",o)}));return e.then((e=>{e instanceof IDBCursor&&n.set(e,t)})).catch((()=>{})),s.set(e,t),e}(t);if(a.has(t))return a.get(t);const e=d(t);return e!==t&&(a.set(t,e),s.set(e,t)),e}const f=t=>s.get(t);const h=["get","getKey","getAll","getAllKeys","count"],w=["put","add","delete","clear"],p=new Map;function y(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(p.get(e))return p.get(e);const i=e.replace(/FromIndex$/,""),n=e!==i,r=w.includes(i);if(!(i in(n?IDBIndex:IDBObjectStore).prototype)||!r&&!h.includes(i))return;const o=async function(t,...e){const o=this.transaction(t,r?"readwrite":"readonly");let a=o.store;return n&&(a=a.index(e.shift())),(await Promise.all([a[i](...e),r&&o.done]))[0]};return p.set(e,o),o}c=(t=>({...t,get:(e,i,n)=>y(e,i)||t.get(e,i,n),has:(e,i)=>!!y(e,i)||t.has(e,i)}))(c);const m={t:function(t,e,{blocked:i,upgrade:n,blocking:r,terminated:o}={}){const a=indexedDB.open(t,e),s=u(a);return n&&a.addEventListener("upgradeneeded",(t=>{n(u(a.result),t.oldVersion,t.newVersion,u(a.transaction))})),i&&a.addEventListener("blocked",(()=>i())),s.then((t=>{o&&t.addEventListener("close",(()=>o())),r&&t.addEventListener("versionchange",(()=>r()))})).catch((()=>{})),s}("myfaveTT",2,{upgrade(t,e,i,n){switch(e){case 0:t.createObjectStore("likesCache"),t.createObjectStore("followingCache");case 1:t.createObjectStore("misc")}}})},g={i:async t=>(await m.t).get("misc",t),o:async(t,e)=>(await m.t).put("misc",e,t)},v="chrome-extension://gmajiifkcmjkehmngbopoobeplhoegad";function C(t,e){ui.postMessage({type:t,payload:e},v)}const k=C;function _(t,e){ui.postMessage({type:t,payload:e},v)}function b(t,e,i){C(1,{err:t,location:e,silently:i})}async function P(t,e){try{const i=e.split("/"),n=i.pop();let r=t;for(const t of i)r=await r.getDirectoryHandle(t,{create:!0});return await r.getFileHandle(n,{create:!0})}catch(t){throw b(t,"gfh29"),t}}async function T(t,e){const i=await t.createWritable();await i.write(e),await i.close()}const D={schemaVersion:1,user:{uid:"",id:"",uniqueId:"",nickname:""},authors:{},videos:{},likes:{downloadStatus:"unset",officialList:[],downloaded:new Set,lastRun:{collect:0,download:0}},following:{officialAuthorList:new Set,started:new Set,notInterested:new Set,downloadLog:{},lastRun:{}}};function S(t){return e=function(t){return JSON.stringify(t,(function(t,e){return e instanceof Set?[...e]:"string"==typeof e?e.replaceAll("`","èƒŒð“„¹å‰ƒ").replaceAll("${","â‘€â¦ƒ"):e}))}(t),"db=String.raw`{}`;".slice(0,"db=String.raw`{}`;".indexOf("{"))+e+"db=String.raw`{}`;".slice("db=String.raw`{}`;".lastIndexOf("}")+1);var e}function I(t){return""===t?D:function(t){const e=JSON.parse(t,(function(t,e){switch(t){case"downloaded":case"notInterested":case"started":case"officialAuthorList":if(Array.isArray(e))return new Set(e)}return"string"==typeof e?e.replaceAll("â‘€â¦ƒ","${").replaceAll("èƒŒð“„¹å‰ƒ","`"):e}));for(const[t,i]of Object.entries(e.following.downloadLog))e.following.downloadLog[t]=new Set(i);return e}(function(t){const e=t.indexOf("{"),i=t.lastIndexOf("}")-t.length+1;return t.slice(e,i)}(t))}const E=new class{constructor(){this.l=null,this.u=null}async h(t,e){this.l=t,this.u=e,C(8),g.o("archiveFolderHandle",t)}async p(){try{T(await P(this.l,"data/.appdata/db.js"),S(this.u))}catch(t){b(t,"a42")}}async m(t){try{const{archiveHtml:e,appJs:i}=t;T(await P(this.l,"Archive.html"),e),T(await P(this.l,"data/.appdata/app.js"),i)}catch(t){b(t,"a58")}}g(t){t.forEach((t=>{const{id:e,uniqueId:i,nickname:n,signature:r}=t.user,{followerCount:o,videoCount:a,heartCount:s}=t.stats,c={uniqueIds:[i],nicknames:[n],followerCount:o,heartCount:s,videoCount:a,signature:r},l=this.u.authors[e];l&&(c.uniqueIds=[...new Set([i,...l.uniqueIds])],c.nicknames=[...new Set([n,...l.nicknames])]),this.u.authors[e]=c})),this.u.following.officialAuthorList=new Set(t.map((t=>t.user.id))),this.p()}async v(t){try{if(!this.u.following.started.has(t)&&!this.u.following.downloadLog[t])return;this.u.following.started.delete(t),delete this.u.following.downloadLog[t],await this.p();let e=await this.l.getDirectoryHandle("data");e=await e.getDirectoryHandle("Following"),e=await e.getDirectoryHandle(t),await e.removeEntry("videos",{recursive:!0})}catch(t){b(t,"purge failed","silently")}}},A={C(t,e){C(2,{event:t,params:e})}};const $={};async function x(){const t=[];Object.entries($).forEach((async([e,i])=>{const{createTime:n,cover:r,dynamicCover:o,video:a}=i;if(Boolean(r&&o&&a))t.push(async function(t){var e;const{startWritingToDiskTime:i,key:n,likedOrFollowing:r,itemData:{id:o,author:a},cover:s,dynamicCover:c,video:l,size:d}=t;if(0!==i){return Date.now()-i<1e4?void 0:(delete $[n],void A.C("stuck in writing"))}t.startWritingToDiskTime=Date.now();try{const t="liked"===r?"data/Likes":`data/Following/${a.id}`,i=`${t}/covers/${o}.jpg`,u=`${t}/animated-covers/${o}.webp`,f=`${t}/videos/${o}.mp4`,h=P(E.l,i).then((t=>T(t,s))),w=P(E.l,u).then((t=>T(t,c))),p=P(E.l,f).then((t=>T(t,l)));if(await Promise.all([h,w,p]),E.u.videos[o].size=d,"following"===r){const t=E.u.following.downloadLog;t[e=a.id]||(t[e]=new Set),t[a.id].add(o)}else E.u.likes.downloaded.add(o)}catch(t){b(t,"ts71","silently")}finally{delete $[n],Object.keys($).length}}(i));else{Date.now()-n>3e4&&(delete $[e],A.C("took over 30 seconds"))}})),t.length&&(await Promise.allSettled(t),await E.p())}const B=new class{addNew(t){$[t.key]=t}k(t,e){$[t].cover=e}_(t,e){$[t].dynamicCover=e}P(t,e){$[t].size=e}T(t,e){$[t]&&($[t].video=e,x())}};function N(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)}function z(t,e,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(t,i):r?r.value=i:e.set(t,i),i}const R=new Set(["BIF","CLP","DJF","GNF","JPY","KMF","KRW","MGA","PYG","RWF","UGX","VND","VUV","XAF","XOF","XPF"]);function M(t){return new Promise((e=>{setTimeout((()=>{e(t)}),t)}))}function O(t){const e=5e3,i={unlocked:["unlock_0_to_1000_likes_(free)"],cap:1e3,nextToBuy:"unlock_1001_to_5000_likes",lineItemDescription:'"Enable downloading more than 1000, up to 5000 videos from your Likes on TikTok."'};if(0===t)return i;const n=[i.unlocked[0]],r=e*t,o=r+e,a=`unlock_${r+1}_to_${o}_likes`,s=`"Enable downloading more than ${r}, up to ${o} videos from your Likes on TikTok."`;for(let e=0;e<t;e++)n.push(O(e)?.nextToBuy);return{unlocked:n,cap:r,nextToBuy:a,lineItemDescription:s}}async function W(t,e){const i=await P(E.l,`data/Following/${e}`),n=await i.getFile();if(n.size>0){const t=6048e5;if(Date.now()-n.lastModified<t)return}const r=await fetch(t),o=r.headers.get("Content-Type");"image/jpeg"!==o&&b(new Error(`avatar type is ${o}`),"daa9");const a=await r.blob(),s=await i.createWritable();await s.write(a),await s.close(),e.includes("avatar_small")&&await M(200),e.includes("avatar_large")&&await M(2e3)}Object.entries({USD:{description:"US Dollar",countryCode:"US",localeCode:"en-us",stripePrice:970,localizedPriceTag:""},EUR:{description:"Euro",countryCode:"EU",localeCode:"en-gb",stripePrice:770,localizedPriceTag:""},GBP:{description:"British Pound",countryCode:"GB",localeCode:"en-gb",stripePrice:680,localizedPriceTag:""},CAD:{description:"Canadian Dollar",countryCode:"CA",localeCode:"en",stripePrice:1170,localizedPriceTag:""},AUD:{description:"Australian Dollar",countryCode:"AU",localeCode:"en",stripePrice:1370,localizedPriceTag:""},KRW:{description:"South Korean Won",countryCode:"KR",localeCode:"ko",stripePrice:11700,localizedPriceTag:""},JPY:{description:"Japanese Yen",countryCode:"JP",localeCode:"ja",stripePrice:1070,localizedPriceTag:""},RUB:{description:"Russian Ruble",countryCode:"RU",localeCode:"ru",stripePrice:67e3,localizedPriceTag:""},INR:{description:"Indian Rupee",countryCode:"IN",localeCode:"en-in",stripePrice:67e3,localizedPriceTag:""},BRL:{description:"Brazilian Real",countryCode:"BR",localeCode:"pt-br",stripePrice:4400,localizedPriceTag:""},ILS:{description:"Israeli New Shekel",countryCode:"IL",localeCode:"en",stripePrice:2700,localizedPriceTag:""},PHP:{description:"Philippine Piso",countryCode:"PH",localeCode:"en",stripePrice:44e3,localizedPriceTag:""},PLN:{description:"Polish Zloty",countryCode:"PL",localeCode:"pl",stripePrice:3700,localizedPriceTag:""},IDR:{description:"Indonesian Rupiah",countryCode:"ID",localeCode:"in",stripePrice:137e5,localizedPriceTag:""},MXN:{description:"Mexican Peso",countryCode:"MX",localeCode:"en",stripePrice:17e3,localizedPriceTag:""},CNY:{description:"Chinese Yuan",countryCode:"CN",localeCode:"en",stripePrice:4700,localizedPriceTag:""},HKD:{description:"Hong Kong Dollar",countryCode:"HK",localeCode:"zh-HK",stripePrice:7700,localizedPriceTag:""},TWD:{description:"New Taiwan Dollar",countryCode:"TW",localeCode:"zh",stripePrice:27e3,localizedPriceTag:""},MYR:{description:"Malaysian Ringgit",countryCode:"MY",localeCode:"ms",stripePrice:3700,localizedPriceTag:""},NZD:{description:"New Zealand Dollar",countryCode:"NZ",localeCode:"en",stripePrice:1400,localizedPriceTag:""},CHF:{description:"Swiss Franc",countryCode:"CH",localeCode:"en",stripePrice:880,localizedPriceTag:""},SGD:{description:"Singapore Dollar",countryCode:"SG",localeCode:"en",stripePrice:1400,localizedPriceTag:""},UAH:{description:"Ukrainian Hryvnia",countryCode:"UA",localeCode:"uk",stripePrice:24e3,localizedPriceTag:""},ARS:{description:"Argentine Peso",countryCode:"AR",localeCode:"es",stripePrice:97e3,localizedPriceTag:""},ZAR:{description:"South African Rand",countryCode:"ZA",localeCode:"en",stripePrice:13500,localizedPriceTag:""},NOK:{description:"Norwegian Krone",countryCode:"NO",localeCode:"no",stripePrice:8500,localizedPriceTag:""},SEK:{description:"Swedish Krona",countryCode:"SE",localeCode:"sv",stripePrice:7500,localizedPriceTag:""},DKK:{description:"Danish Krone",countryCode:"DK",localeCode:"da",stripePrice:6e3,localizedPriceTag:""},VND:{description:"Vietnamese dong",countryCode:"VN",localeCode:"vi",stripePrice:19e4,localizedPriceTag:""}}).forEach((([t,e])=>{const i=R.has(t)?e.stripePrice:e.stripePrice/100;e.localizedPriceTag=new Intl.NumberFormat(e.localeCode,{style:"currency",useGrouping:!1,currency:t}).format(i)}));const L={D:!1},j=t=>e=>{const i={};for(const n of t)i[n]=e[n];return i},F=t=>e=>{const i={};return e.forEach((e=>{i[e[t]]=e})),i};function U(t){const e=j(["id","desc","createTime","itemMute"])(t);return e.video=j(["id","cover","dynamicCover","playAddr","downloadAddr","format"])(t.video),e.stats=j(["diggCount","playCount"])(t.stats),e.author=j(["id","uniqueId","nickname","avatarLarger"])(t.author),e.authorStats=j(["followerCount","heartCount","videoCount"])(t.authorStats),e}function H(t){return j(["id","uniqueId","nickname","avatarLarger","avatarThumb","signature"])(t.user)}const K=new class{constructor(){this.S="initial",this.I={}}async A(){if(window.__NEXT_DATA__)try{this.I=window.__NEXT_DATA__.props.initialProps,this.S="next"}catch(t){b(t,"ac26"),this.S="error"}else if(window.SIGI_STATE)try{this.I=window.SIGI_STATE.AppContext.appContext,this.S="sigi"}catch(t){b(t,"ac37"),this.S="error"}else try{const t=await fetch("/node-webapp/api/app-context"),e=await t.json();0===e.statusCode?(this.I=e,this.S="fetched"):(b(new Error(e),"ac49"),this.S="error")}catch(t){b(t,"ac52"),this.S="error"}A.C("app_context",{status:this.S}),this.S}$(){const{$wid:t,$region:e,$os:i,$language:n,$user:r}=this.I;if(!(t&&e&&i&&n))return b(new Error(JSON.stringify({$wid:t,$region:e,$os:i,$language:n})),"ac64"),!1;if(!r)return!0;const{uid:o,region:a,uniqueId:s,secUid:c,nickName:l}=r;return!!(o&&a&&s&&c&&l)||(b(new Error(JSON.stringify({uid:o,region:a,uniqueId:s,secUid:c,nickName:l})),"ac75"),!1)}};var V,q,J;class G{constructor(t){return V.add(this),q.set(this,void 0),z(this,q,"likes"===t?new URL("https://m.tiktok.com/api/favorite/item_list/"):new URL("https://m.tiktok.com/api/user/list/"),"f"),N(this,V,"m",J).call(this),this}B(t){return N(this,q,"f").searchParams.set("cursor",t),this}N({maxCursor:t,minCursor:e}){return N(this,q,"f").searchParams.set("maxCursor",String(t)),N(this,q,"f").searchParams.set("minCursor",String(e)),this}R(t){return N(this,q,"f").searchParams.set("count",String(t)),this}M(){return N(this,q,"f").toString()}}q=new WeakMap,V=new WeakSet,J=function(){const t=Object.assign({},function(){var t;return{aid:"1988",app_name:"tiktok_web",device_platform:"web_pc",referer:document.referrer,cookie_enabled:navigator.cookieEnabled,screen_width:screen.width,screen_height:screen.height,browser_language:navigator.language,browser_platform:navigator.platform,browser_name:navigator.appCodeName,browser_version:navigator.appVersion,browser_online:navigator.onLine,verifyFp:null===(t=document.cookie.match(/s_v_web_id=(\w+)/))||void 0===t?void 0:t[1],timezone_name:Intl.DateTimeFormat().resolvedOptions().timeZone,is_page_visible:!0,focus_state:!0,is_fullscreen:window.matchMedia("(display-mode: fullscreen)").matches,history_len:window.history.length,battery_info:{}}}(),function(){const{$wid:t,$region:e,$language:i,$os:n,$user:r}=K.I;return{device_id:t,region:e,priority_region:r.region,os:n,app_language:i,secUid:r.secUid,language:i}}());Object.entries(t).forEach((([t,e])=>{N(this,q,"f").searchParams.set(t,(null==e?void 0:e.toString())||"")}))};const Y=1e3,Z=["unset","downloading","paused","capped","completed"],X=["downloading","completed","capped","pausing","paused","resuming"],Q={O:"unset",W:{L(t){C(16,t)},j(t){C(17,t)}},F:{U(t){k(11,{progress:t})},H(t){X.includes(t)&&k(11,{status:t}),Z.includes(t)&&(E.u.likes.downloadStatus=t)}}};function tt(t){if(!t)return!1;const e=new URL(t),i=e.searchParams.get("expire")||e.searchParams.get("x-expires");return(Number(i+"000")-Date.now())/1e3/60<10}function et(t){return[t.video.playAddr,t.video.cover,t.video.dynamicCover].some(tt)}function it(t){return t.some(et)}function nt(t){return{async K(){const e=await m.t,i=await e.get("followingCache",t);return i?it(i)?[]:i.sort(((t,e)=>t.createTime-e.createTime)):[]},o:async e=>(await m.t).put("followingCache",e,t),async V(t){return(await this.K()).map((t=>t.id)).includes(t.id)}}}function rt(t){const e=F("id")(t),i=t.map((t=>t.id));return[...new Set(i)].map((t=>e[t]))}var ot,at,st,ct;const lt=new(ct=class{constructor(){ot.add(this),this.S="unset",at.set(this,"unset")}q(){try{if(this.S===(this.S="expanding"))return;const t=document.querySelectorAll(".user-list"),e=t[t.length-1];if(!e)return b(new Error("no author lists found"),"sa35"),void(this.S="failed");if("A"===e.lastChild.tagName)return void(this.S="expanded");if("unset"===N(this,at,"f"))return z(this,at,e.lastChild.textContent,"f"),N(this,at,"f"),void N(this,ot,"m",st).call(this,e);if(N(this,at,"f")===e.lastChild.textContent)return void N(this,ot,"m",st).call(this,e);if(e.lastChild.textContent!==N(this,at,"f"))return void(this.S="expanded")}catch(t){b(t,"ale19")}}},at=new WeakMap,ot=new WeakSet,st=async function(t){for(var e,i;;){if(null===(e=t.lastChild)||void 0===e||e.click(),await M(2e3),"A"===t.lastChild.tagName)return void(this.S="expanded");if((null===(i=t.lastChild)||void 0===i?void 0:i.textContent)!==N(this,at,"f"))return void(this.S="expanded")}},ct);async function dt(t){for(lt.q();;){const e=document.querySelector(`a[href*="${t}"]`);if(e)return void e.click();if("expanded"===lt.S)return void b(new Error("Author list already fully expanded, but couldn't find author to click"),"sa22");await M(500)}}var ut,ft,ht,wt;class pt{constructor(t,e){this.J=t,this.G=e,ut.add(this),this.Y=this.J.id+this.G}get Z(){var t;return"liked"===this.G?Boolean(E.u.likes.downloaded.has(this.J.id)):Boolean(null===(t=E.u.following.downloadLog[this.J.author.id])||void 0===t?void 0:t.has(this.J.id))}X(){return et(this.J)}async tt(){B.addNew({createTime:Date.now(),startWritingToDiskTime:0,key:this.Y,likedOrFollowing:this.G,itemData:this.J}),await N(this,ut,"m",ft).call(this),await N(this,ut,"m",ht).call(this),await N(this,ut,"m",wt).call(this)}et(){try{E.u.videos[this.J.id]=function(t,e){const i={authorId:t.author.id,desc:t.desc,createTime:t.createTime,itemMute:t.itemMute,diggCount:t.stats.diggCount,playCount:t.stats.playCount},n=e.videos[t.id];return Object.assign({},n,i)}(this.J,E.u),E.u.authors[this.J.author.id]=function(t,e){const i={uniqueIds:[t.author.uniqueId],nicknames:[t.author.nickname],followerCount:t.authorStats.followerCount,heartCount:t.authorStats.heartCount,videoCount:t.authorStats.videoCount},n=e.authors[t.author.id];n&&(i.uniqueIds=[...new Set([...i.uniqueIds,...n.uniqueIds])],i.nicknames=[...new Set([...i.nicknames,...n.nicknames])]);return Object.assign({},n,i)}(this.J,E.u)}catch(t){b(t,"i77")}}}ut=new WeakSet,ft=async function(){const t=await fetch(this.J.video.cover),e=t.headers.get("Content-Type");if("image/jpeg"!==e)throw new Error(`cover type is ${e}`);const i=await t.arrayBuffer();B.k(this.Y,i)},ht=async function(){const t=await fetch(this.J.video.dynamicCover),e=t.headers.get("Content-Type");if("image/webp"!==e)throw new Error(`animated cover is ${e}`);const i=await t.arrayBuffer();B._(this.Y,i)},wt=async function(){const t=await fetch(this.J.video.playAddr),e=t.headers.get("Content-Type");if("video/mp4"!==e)throw new Error(`video type is ${e}`);const i=t.headers.get("Content-Length");B.P(this.Y,(Number(i)/1024/1024).toFixed(1)+"MB");const n=await t.arrayBuffer();_("please_resync_this_video",{tempStorageKey:this.Y,arrayBuffer:n})};const yt={it:!1};var mt,gt,vt,Ct,kt,_t,bt;const Pt=new(bt=class{constructor(){mt.add(this),gt.set(this,[]),this.nt="",vt.set(this,null)}async rt(t,e){try{this.nt=t,z(this,gt,[],"f"),document.documentElement.style.overflow="hidden",document.documentElement.style.pointerEvents="none",document.querySelector("aside#myfaveTT-container").style.pointerEvents="auto",await dt(e),await M(2e3),N(this,mt,"m",Ct).call(this)}catch(t){b(t,"sr48")}}async ot(t){if(0===t.length)return void b(new Error("repeat failed?"),"scr78","silently");const e=function(t){const e=t[0].author.id;if(t.some((t=>t.author.id!==e)))throw new Error("not all videos share the same author");return e}(t);if(e!==this.nt)return;if(it(N(this,gt,"f")))return N(this,mt,"m",_t).call(this),$t.at(e),void(this.nt="");N(this,gt,"f").push(...t),Q.W.L(N(this,gt,"f").length);if(!await nt(e).V(N(this,gt,"f")[N(this,gt,"f").length-1]))return N(this,gt,"f").length>Y?(z(this,gt,N(this,gt,"f").slice(0,Y),"f"),void await this.st()):void 0;await this.st()}async st(){var t;try{if(!this.nt)return;const e=this.nt;this.nt="",N(this,mt,"m",_t).call(this);const i=await nt(e).K(),n=rt(N(this,gt,"f").concat(i));await nt(e).o(n),n.length,(t=E.u.following.lastRun)[e]||(t[e]={scroll:0,download:0}),E.u.following.lastRun[e].scroll=Date.now(),E.p(),async function(t){E.u.following.started.add(t);const e=await nt(t).K();for(const[i,n]of e.entries()){for(;yt.it;)await M(500);const r=new pt(n,"following");if(r.et(),!r.Z){if(r.X())return void $t.at(t);Q.W.j({total:e.length,current:i+1}),r.tt().catch((t=>b(t,"doa22","silently"))),await M(6e3)}}E.u.following.lastRun[t].download=Date.now(),await M(2e3),await $t.at(t)}(e)}catch(t){b(t,"blf73")}}},gt=new WeakMap,vt=new WeakMap,mt=new WeakSet,Ct=function(){N(this,vt,"f")&&clearInterval(N(this,vt,"f")),z(this,vt,setInterval((()=>N(this,mt,"m",kt).call(this)),2e3),"f")},kt=async function(){try{if("hidden"===document.visibilityState)return;if(!this.nt)return;!function(){const{scrollHeight:t,scrollTop:e,clientHeight:i}=document.documentElement;return t-e-i<20}()?window.scrollBy(0,window.innerHeight):(await M(2e3),await this.st())}catch(t){b(t,"fl58")}},_t=function(){clearInterval(N(this,vt,"f"))},bt);var Tt,Dt,St,It,Et,At;const $t=new(At=class{constructor(){Tt.add(this),this.ct={},this.lt={alreadyInArchive:[],willAddToArchive:[],notInterested:[]},Dt.set(this,[])}async dt(){try{const t=await async function(){let t=[],[e,i]=[0,0],n=0;do{await M(1e3);const r=new G("following").N({maxCursor:e,minCursor:i}).R(0===e?10:20);try{const n=await window.fetch(r.M(),{credentials:"include"}),o=await n.json(),{statusCode:a,userList:s}=o;if(0!==a)throw new Error("bad res");if(t=(s||[]).concat(t),({maxCursor:e,minCursor:i}=o),k(13,{currentTotal:t.length}),"number"!=typeof e||"number"!=typeof i)throw new Error("Things have changed? Author cursor is no longer number?")}catch(e){if(n++,n<=3)continue;return b(e,"ff30"),t}if(n=0,0===t.length)return[]}while("-1"!==String(e)&&"-1"!==String(i));return t}();if(!L.D)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");E.g(t),async function(t){for(const e of t){const{id:t,avatarThumb:i}=e.user;await W(i,`${t}/avatar_small.jpg`)}for(const e of t){const{id:t,avatarLarger:i}=e.user;await W(i,`${t}/avatar_large.jpg`)}}(t);const e=t.map(H);this.ct=F("id")(e),C(14,{authorDict:this.ct,started:[...E.u.following.started],notInterested:[...E.u.following.notInterested]})}catch(t){b(t,"ff27")}}async ut(t){C(20,"following"),this.lt=t,E.u.following.notInterested=new Set(t.notInterested);const e=[...t.willAddToArchive,...t.alreadyInArchive].sort(((t,e)=>{var i,n;return((null===(i=E.u.following.lastRun[t])||void 0===i?void 0:i.download)||0)-((null===(n=E.u.following.lastRun[e])||void 0===n?void 0:n.download)||0)}));z(this,Dt,e.map((t=>({authorId:t,status:"queued"}))),"f"),await E.p(),await N(this,Tt,"m",St).call(this),await N(this,Tt,"m",It).call(this)}async at(t){try{const e=N(this,Dt,"f").find((e=>e.authorId===t));e&&(e.status="finished"),await E.p(),await N(this,Tt,"m",It).call(this)}catch(t){b(t,"ff101")}}},Dt=new WeakMap,Tt=new WeakSet,St=async function(){for(const t of E.u.following.officialAuthorList)this.lt.alreadyInArchive.includes(t)||this.lt.willAddToArchive.includes(t)||await E.v(t)},It=async function(){const t=N(this,Dt,"f").find((t=>"queued"===t.status));if(t){t.status="current";const e=this.ct[t.authorId].uniqueId;await Pt.rt(t.authorId,e),C(15,N(this,Dt,"f"))}else N(this,Tt,"m",Et).call(this)},Et=function(){const{officialAuthorList:t,started:e,notInterested:i}=E.u.following;C(18,{numFollowed:t.size,numStarted:e.size,numNotInterested:i.size,numCappedOut:[...t].filter((t=>!e.has(t))).filter((t=>!i.has(t))).length})},At),xt=new class{constructor(){this.ft={}}o(t){this.ft=t}};function Bt(){try{return O(xt.ft.unlocks.likeLevel).cap}catch(t){return b(t,"ud17"),0}}function Nt(){return xt.ft.profile.uid}const zt={async i(){const t=await m.t;return await t.get("likesCache",Nt())||[]},o:async t=>(await m.t).put("likesCache",t,Nt()),async ht(){it(await this.i())&&await this.o([])},async V(t){return(await this.i()).map((t=>t.id)).includes(t.id)}};function Rt(t){if(!t.id||!t.video||!t.author)return b(new Error(JSON.stringify(t)),"pid27","silently"),!1;if(!t.video.downloadAddr)return console.error("No downloadAddr"),!1;if(!t.video.playAddr)return b(new Error(JSON.stringify(t.video)),"pid35","silently"),!1;if(!t.video.cover)return b(new Error(JSON.stringify(t.video)),"pid39","silently"),!1;if(!t.video.dynamicCover)return!1;if(t.id!==t.video.id)return b(new Error(`${t.id} different from ${t.video.id}`),"pid49","silently"),!1;if("mp4"!==t.video.format)return b(new Error(`video format is ${t.video.format}`),"pid56","silently"),!1;if(t.video.downloadAddr!==t.video.playAddr)return b(new Error(`downloadAddr ${t.video.downloadAddr} different from playAddr ${t.video.playAddr}`),"pid65","silently"),!1;if(!t.video.playAddr.includes(".tiktok.com"))return b(new Error(`Video url not in tiktok.com: ${t.video.playAddr}`),"pid72","silently"),!1;if(!t.video.cover.includes("tiktokcdn"))return b(new Error(`Cover url not in tiktokcdn: ${t.video.cover}`),"pid79","silently"),!1;if(!t.video.dynamicCover.includes("tiktokcdn"))return b(new Error(`Gif url not in tiktokcdn: ${t.video.dynamicCover}`),"pid86","silently"),!1;for(const e of[t.video.playAddr,t.video.cover,t.video.dynamicCover]){const t=new URL(e),i=t.searchParams.get("expire")||t.searchParams.get("x-expires");if(!i||10!==i.length)return b(new Error(`url schema changed?: ${e}`),"pid89","silently"),!1}return!0}async function Mt(){const t=await async function(){const t=[];let e="0",i=!0,n=0,r=0;for(await zt.ht();i;){await M(1e3);const o=new G("likes").B(e).R(30),a=await window.fetch(o.M(),{credentials:"include"}),s=await a.json(),{statusCode:c,itemList:l}=s;if(0!==c){if(n++,n<=3)continue;b(new Error(`Err fetching likes: ${o.M()}`),"ff30");break}if(n=0,l){if(l.some((t=>!Rt(t)))&&(r++,r<=3))continue;r=0,t.push(...l.map(U).filter(Rt)),k(9,{currentTotal:t.length})}if(0===t.length)return[];if(await zt.V(t[t.length-1]))break;({cursor:e,hasMore:i}=s)}return t}(),e=await zt.i(),i=rt(t.concat(e));await zt.o(i)}var Ot,Wt,Lt,jt,Ft,Ut,Ht,Kt,Vt;const qt=new(Vt=class{constructor(){Ot.add(this),Wt.set(this,[]),Lt.set(this,!1),jt.set(this,0)}async wt(){z(this,Lt,!0,"f"),await M(1e3),Q.F.H("paused"),E.p()}async yt(){z(this,Lt,!1,"f")}async gt(){var t;await N(this,Ot,"m",Ut).call(this);try{if(0===N(this,Wt,"f").length)return void k(10);if(!L.D)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");E.u.likes.officialList=N(this,Wt,"f").map((t=>t.id));const{finalDownloadOutcome:e}=await N(this,Ot,"m",Ht).call(this);if("someUrlExpired"===e)return z(this,jt,1+(t=+N(this,jt,"f")),"f"),t>3?void b(new Error("Session too long, please reload"),"bl46"):void this.gt();N(this,Ot,"m",Kt).call(this,e)}catch(t){b(t,"bl50")}}},Wt=new WeakMap,Lt=new WeakMap,jt=new WeakMap,Ot=new WeakSet,Ft=function(){return E.u.likes.downloaded.size>=Bt()},Ut=async function(){try{await Mt(),E.u.likes.lastRun.collect=Date.now(),z(this,Wt,await zt.i(),"f")}catch(t){throw b(t,"bl32"),t}},Ht=async function(){C(20,"likes"),Q.F.U({total:N(this,Wt,"f").length,nowAt:0});for(const t of N(this,Wt,"f")){new pt(t,"liked").et()}for(const[t,e]of N(this,Wt,"f").reverse().entries()){const i=new pt(e,"liked");if(!i.Z){if(N(this,Ot,"m",Ft).call(this))return{finalDownloadOutcome:"capped"};for(;N(this,Lt,"f");)await M(1e3);if(i.X())return{finalDownloadOutcome:"someUrlExpired"};Q.F.H("downloading"),Q.F.U({total:N(this,Wt,"f").length,nowAt:t+1}),i.tt().catch((t=>b(t,"bl75","silently"))),N(this,Lt,"f")||await M(6e3)}}return{finalDownloadOutcome:"completed"}},Kt=async function(t){const e={officialListLength:E.u.likes.officialList.length,numMp4InLocalFolder:E.u.likes.downloaded.size,status:t};E.u.likes.lastRun.download=Date.now(),await M(200),k(12,e),Q.F.H(t),await E.p()},Vt);function Jt(t){k(6,t)}let Gt=!1;var Yt,Zt,Xt,Qt,te,ee,ie,ne,re,oe,ae;const se=new(ae=class{constructor(){Yt.add(this),Zt.set(this,null)}async vt(){const t=await g.i("archiveFolderHandle"),e=await showDirectoryPicker({startIn:t});N(this,Yt,"m",ne).call(this,e)}Ct(){var t;N(this,Yt,"m",Xt).call(this),k(5),null===(t=document.getElementById("myfaveTT-container"))||void 0===t||t.appendChild(N(this,Zt,"f"))}},Zt=new WeakMap,Yt=new WeakSet,Xt=function(){z(this,Zt,document.createElement("div"),"f"),N(this,Zt,"f").id="dropbox",N(this,Zt,"f").innerHTML='<svg viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"></path></svg>',N(this,Zt,"f").addEventListener("dragover",(t=>{t.preventDefault()})),N(this,Zt,"f").addEventListener("dragenter",(()=>{N(this,Yt,"m",Qt).call(this)})),N(this,Zt,"f").addEventListener("dragleave",(()=>{N(this,Yt,"m",te).call(this)})),N(this,Zt,"f").addEventListener("drop",(t=>{try{N(this,Yt,"m",ee).call(this,t)}catch(t){b(t,"db30","silently")}}))},Qt=function(){var t;null===(t=N(this,Zt,"f"))||void 0===t||t.classList.add("dragging-over")},te=function(){var t;null===(t=N(this,Zt,"f"))||void 0===t||t.classList.remove("dragging-over")},ee=async function(t){if(t.preventDefault(),N(this,Yt,"m",te).call(this),!t.dataTransfer)return void N(this,Yt,"m",ie).call(this);if(1!==t.dataTransfer.items.length)return void N(this,Yt,"m",ie).call(this);const e=t.dataTransfer.items[0];if("file"!==e.kind)return void N(this,Yt,"m",ie).call(this);const i=await e.getAsFileSystemHandle();if(i&&"directory"===i.kind)try{N(this,Yt,"m",ne).call(this,i)}catch(t){b(t,"db67")}else N(this,Yt,"m",ie).call(this)},ie=function(){Jt({dropResult:"not_a_folder"})},ne=async function(t){if("granted"!==await t.requestPermission({mode:"readwrite"}))return;if(!await async function(t){if(await async function(t){const e=[];for await(const i of t.keys())e.push(i);return 0===e.length}(t))return!!Gt||(Gt=!0,!xt.ft.behavior.hasCreatedArchiveFolder||(Jt({dropResult:"unexpectedly_empty"}),!1));try{await t.getFileHandle("Archive.html");const e=await t.getDirectoryHandle("data"),i=await e.getDirectoryHandle(".appdata");return await i.getFileHandle("app.js"),!0}catch(t){return Jt({dropResult:"content_seems_wrong"}),!1}}(t))return;const e=await async function(t){const e=await P(t,"data/.appdata/db.js"),i=await e.getFile(),n=I(await i.text()),{id:r,uid:o,uniqueId:a,nickname:s}=xt.ft.profile;return n.user.id.length>0&&n.user.id!==r?(Jt({dropResult:"belongs_to_another_tiktok_account",belongsToUser:n.user.uniqueId}),null):(n.user={uid:o,id:r,uniqueId:a,nickname:s},n)}(t);e&&N(this,Yt,"m",re).call(this,t,e)},re=async function(t,e){L.D||_("is_resync_ready"),C(7),await E.h(t,e),"following"===Q.O?$t.dt():qt.gt(),N(this,Yt,"m",oe).call(this)},oe=function(){var t;null===(t=N(this,Zt,"f"))||void 0===t||t.remove(),z(this,Zt,null,"f")},ae);function ce(){var e;null===(e=document.getElementById("myfaveTT-container"))||void 0===e||e.remove(),document.body.classList.remove("pushed-by-myfaveTT"),t.onmessage=null,t.close(),window.removeEventListener("message",ue)}let le="";async function de(e){try{const{type:i,payload:n}=e.data;if(0===i)return void t.postMessage({type:1});if(1===i)return ce(),void alert("Not loading myFaveTT sidebar, because it's already running in another tab.");if(100===i)return C(3,n),void lt.q();if(102===i)return void C(19,n);if(101===i){if(!Pt.nt)return;if(le===(le=JSON.stringify(e.data)))return void console.error("double listener?!");try{const t=await async function(t){const e=t.find((t=>"x-tt-params"===t.name));if(!e)return[];const i={[e.name]:e.value,Accept:"application/json, text/plain, text/csv, */*"};let n=0,r=0;for(;;){await M(1e3);const t=await fetch("https://m.tiktok.com/api/post/item_list/",{headers:i,credentials:"include"}),e=await t.json(),{statusCode:o,itemList:a}=e;if(0!==o){if(n++,n<=3)continue;return b(new Error("Error in repeat captured request. "),"bf31"),[]}if(!a)return[];if(a.some((t=>!Rt(t)))){if(r++,r<=3)continue;b(new Error("still flawed"),"bf45","silently")}return a.map(U).filter(Rt)}}(n);await Pt.ot(t)}catch(t){b(t,"om82")}}}catch(t){b(t,"om41")}}async function ue(e){try{const{origin:i,data:{type:n,payload:r}}=e;if(i!==v)return;switch(n){case"resync_is_ready":L.D=!0;break;case"resynced":{const{tempStorageKey:t,arrayBuffer:e}=r;B.T(t,e);break}case 12:se.vt();break;case 1:try{Q.O="likes",E.l?qt.gt():se.Ct()}catch(t){b(t,"om46")}break;case 2:try{Q.O="following",E.l?$t.dt():se.Ct()}catch(t){b(t,"om55")}break;case 3:ce();break;case 4:E.m(r);break;case 0:if(k(0,"1.2.1"),"initial"===K.S){if(await K.A(),"error"===K.S)break;if(!K.$())break}k(4,function(){const t=K.I.$user;return{id:(null==t?void 0:t.uid)||null,secUid:(null==t?void 0:t.secUid)||null,uniqueId:(null==t?void 0:t.uniqueId)||null,nickname:(null==t?void 0:t.nickName)||null}}()),function(e,i){t.postMessage({type:e,payload:i})}(2);break;case 5:qt.wt();break;case 6:qt.yt();break;case 10:yt.it=!0;break;case 11:yt.it=!1;break;case 7:xt.o(r);break;case 8:try{$t.ut(r)}catch(t){b(t,"om161")}break;case 9:dt(r)}}catch(t){b(t,"om136")}}try{t.onmessage=de,window.removeEventListener("message",ue),window.addEventListener("message",ue),t.postMessage({type:0})}catch(t){b(t,"st8")}
