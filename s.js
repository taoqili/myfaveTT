const t=new BroadcastChannel("myfaveTT");let e,n;const i=new WeakMap,r=new WeakMap,o=new WeakMap,a=new WeakMap,s=new WeakMap;let c={get(t,e,n){if(t instanceof IDBTransaction){if("done"===e)return r.get(t);if("objectStoreNames"===e)return t.objectStoreNames||o.get(t);if("store"===e)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set:(t,e,n)=>(t[e]=n,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function u(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(n||(n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(d(this),e),f(i.get(this))}:function(...e){return f(t.apply(d(this),e))}:function(e,...n){const i=t.call(d(this),e,...n);return o.set(i,e.sort?e.sort():[e]),f(i)}}function l(t){return"function"==typeof t?u(t):(t instanceof IDBTransaction&&function(t){if(r.has(t))return;const e=new Promise(((e,n)=>{const i=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",o),t.removeEventListener("abort",o)},r=()=>{e(),i()},o=()=>{n(t.error||new DOMException("AbortError","AbortError")),i()};t.addEventListener("complete",r),t.addEventListener("error",o),t.addEventListener("abort",o)}));r.set(t,e)}(t),n=t,(e||(e=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>n instanceof t))?new Proxy(t,c):t);var n}function f(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,n)=>{const i=()=>{t.removeEventListener("success",r),t.removeEventListener("error",o)},r=()=>{e(f(t.result)),i()},o=()=>{n(t.error),i()};t.addEventListener("success",r),t.addEventListener("error",o)}));return e.then((e=>{e instanceof IDBCursor&&i.set(e,t)})).catch((()=>{})),s.set(e,t),e}(t);if(a.has(t))return a.get(t);const e=l(t);return e!==t&&(a.set(t,e),s.set(e,t)),e}const d=t=>s.get(t);const h=["get","getKey","getAll","getAllKeys","count"],w=["put","add","delete","clear"],y=new Map;function p(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(y.get(e))return y.get(e);const n=e.replace(/FromIndex$/,""),i=e!==n,r=w.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!r&&!h.includes(n))return;const o=async function(t,...e){const o=this.transaction(t,r?"readwrite":"readonly");let a=o.store;return i&&(a=a.index(e.shift())),(await Promise.all([a[n](...e),r&&o.done]))[0]};return y.set(e,o),o}c=(t=>({...t,get:(e,n,i)=>p(e,n)||t.get(e,n,i),has:(e,n)=>!!p(e,n)||t.has(e,n)}))(c);const m={t:function(t,e,{blocked:n,upgrade:i,blocking:r,terminated:o}={}){const a=indexedDB.open(t,e),s=f(a);return i&&a.addEventListener("upgradeneeded",(t=>{i(f(a.result),t.oldVersion,t.newVersion,f(a.transaction))})),n&&a.addEventListener("blocked",(()=>n())),s.then((t=>{o&&t.addEventListener("close",(()=>o())),r&&t.addEventListener("versionchange",(()=>r()))})).catch((()=>{})),s}("myfaveTT",2,{upgrade(t,e,n,i){switch(e){case 0:t.createObjectStore("likesCache"),t.createObjectStore("followingCache");case 1:t.createObjectStore("misc")}}})},v={i:async t=>(await m.t).get("misc",t),o:async(t,e)=>(await m.t).put("misc",e,t)},g="chrome-extension://gmajiifkcmjkehmngbopoobeplhoegad";function k(t,e){ui.postMessage({type:t,payload:e},g)}const b=k;function _(t,e){ui.postMessage({type:t,payload:e},g)}function S(t,e,n){k(1,{err:t,location:e,silently:n})}async function T(t,e){try{const n=e.split("/"),i=n.pop();let r=t;for(const t of n)r=await r.getDirectoryHandle(t,{create:!0});return await r.getFileHandle(i,{create:!0})}catch(t){throw S(t,"gfh29"),t}}async function C(t,e){const n=await t.createWritable();await n.write(e),await n.close()}const D={schemaVersion:1,user:{uid:"",id:"",uniqueId:"",nickname:""},authors:{},videos:{},likes:{downloadStatus:"unset",officialList:[],downloaded:new Set,lastRun:{collect:0,download:0}},following:{officialAuthorList:new Set,started:new Set,notInterested:new Set,downloadLog:{},lastRun:{}}};function I(t){return e=function(t){return JSON.stringify(t,(function(t,e){return e instanceof Set?[...e]:"string"==typeof e?e.replaceAll("`","èƒŒð“„¹å‰ƒ").replaceAll("${","â‘€â¦ƒ"):e}))}(t),"db=String.raw`{}`;".slice(0,"db=String.raw`{}`;".indexOf("{"))+e+"db=String.raw`{}`;".slice("db=String.raw`{}`;".lastIndexOf("}")+1);var e}function x(t){return""===t?D:function(t){const e=JSON.parse(t,(function(t,e){switch(t){case"downloaded":case"notInterested":case"started":case"officialAuthorList":if(Array.isArray(e))return new Set(e)}return"string"==typeof e?e.replaceAll("â‘€â¦ƒ","${").replaceAll("èƒŒð“„¹å‰ƒ","`"):e}));for(const[t,n]of Object.entries(e.following.downloadLog))e.following.downloadLog[t]=new Set(n);return e}(function(t){const e=t.indexOf("{"),n=t.lastIndexOf("}")-t.length+1;return t.slice(e,n)}(t))}const E=new class{constructor(){this.u=null,this.l=null}async h(t,e){this.u=t,this.l=e,k(8),v.o("archiveFolderHandle",t)}async p(){try{C(await T(this.u,"data/.appdata/db.js"),I(this.l))}catch(t){S(t,"a42")}}async m(t){try{const{archiveHtml:e,appJs:n}=t;C(await T(this.u,"Archive.html"),e),C(await T(this.u,"data/.appdata/app.js"),n)}catch(t){S(t,"a58")}}v(t){t.forEach((t=>{const{id:e,uniqueId:n,nickname:i,signature:r}=t.user,{followerCount:o,videoCount:a,heartCount:s}=t.stats,c={uniqueIds:[n],nicknames:[i],followerCount:o,heartCount:s,videoCount:a,signature:r},u=this.l.authors[e];u&&(c.uniqueIds=[...new Set([n,...u.uniqueIds])],c.nicknames=[...new Set([i,...u.nicknames])]),this.l.authors[e]=c})),this.l.following.officialAuthorList=new Set(t.map((t=>t.user.id))),this.p()}async g(t){try{if(!this.l.following.started.has(t)&&!this.l.following.downloadLog[t])return;this.l.following.started.delete(t),delete this.l.following.downloadLog[t],await this.p();let e=await this.u.getDirectoryHandle("data");e=await e.getDirectoryHandle("Following"),e=await e.getDirectoryHandle(t),await e.removeEntry("videos",{recursive:!0})}catch(t){S(t,"purge failed","silently")}}},$={k(t,e){k(2,{event:t,params:e})}};let j=0;function O(){let t;return t=j<=2?5:4+3*(j-2),1e3*t}const A={};async function B(){const t=[];Object.entries(A).forEach((async([e,n])=>{const{createTime:i,cover:r,video:o}=n;if(Boolean(r&&o))t.push(async function(t){var e;const{startWritingToDiskTime:n,key:i,likedOrFollowing:r,itemData:{id:o,author:a},cover:s,video:c,size:u}=t;if(0!==n){return Date.now()-n<1e4?void 0:(delete A[i],void $.k("stuck in writing"))}t.startWritingToDiskTime=Date.now();try{const t="liked"===r?"data/Likes":`data/Following/${a.id}`,n=`${t}/covers/${o}.jpg`,l=`${t}/videos/${o}.mp4`,f=T(E.u,n).then((t=>C(t,s))),d=T(E.u,l).then((t=>C(t,c)));if(await Promise.all([f,d]),E.l.videos[o].size=u,"following"===r){const t=E.l.following.downloadLog;t[e=a.id]||(t[e]=new Set),t[a.id].add(o)}else E.l.likes.downloaded.add(o)}catch(t){S(t,"ts71","silently")}finally{delete A[i]}}(n));else{Date.now()-i>6e4&&(delete A[e],$.k("took over 30 seconds"))}})),t.length&&(await Promise.allSettled(t),await E.p())}const M=new class{addNew(t){A[t.key]=t,j=Object.keys(A).length}_(t,e){A[t]&&(A[t].cover=e,B())}S(t,e){A[t]&&(A[t].size=e)}T(t,e){A[t]&&(A[t].video=e,B())}C(t){A[t],A[t]&&delete A[t]}};function W(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)}function N(t,e,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(t,n):r?r.value=n:e.set(t,n),n}function L(t){return new Promise((e=>{setTimeout((()=>{e(t)}),t)}))}function F(t){const e=5e3,n={unlocked:["unlock_0_to_1000_likes_(free)"],cap:1e3,nextToBuy:"unlock_1001_to_5000_likes",lineItemDescription:'"Enable downloading more than 1000, up to 5000 videos from your Likes on TikTok."'};if(0===t)return n;const i=[n.unlocked[0]],r=e*t,o=r+e,a=`unlock_${r+1}_to_${o}_likes`,s=`"Enable downloading more than ${r}, up to ${o} videos from your Likes on TikTok."`;for(let e=0;e<t;e++)i.push(F(e)?.nextToBuy);return{unlocked:i,cap:r,nextToBuy:a,lineItemDescription:s}}const q=/^\s+|\s+$/g,P=/^[-+]0x[0-9a-f]+$/i,U=/^0b[01]+$/i,R=/^0o[0-7]+$/i,J=parseInt,H="object"==typeof global&&global&&global.Object===Object&&global,z="object"==typeof self&&self&&self.Object===Object&&self,K=H||z||Function("return this")(),V=Object.prototype.toString,G=Math.max,Q=Math.min,X=function(){return K.Date.now()};function Y(t,e,n){let i,r,o,a,s,c,u=0,l=!1,f=!1,d=!0;if("function"!=typeof t)throw new TypeError("Expected a function");function h(e){const n=i,o=r;return i=r=void 0,u=e,a=t.apply(o,n),a}function w(t){return u=t,s=setTimeout(p,e),l?h(t):a}function y(t){const n=t-c;return void 0===c||n>=e||n<0||f&&t-u>=o}function p(){const t=X();if(y(t))return m(t);s=setTimeout(p,function(t){const n=e-(t-c);return f?Q(n,o-(t-u)):n}(t))}function m(t){return s=void 0,d&&i?h(t):(i=r=void 0,a)}function v(){const t=X(),n=y(t);if(i=arguments,r=this,c=t,n){if(void 0===s)return w(c);if(f)return s=setTimeout(p,e),h(c)}return void 0===s&&(s=setTimeout(p,e)),a}return e=tt(e)||0,Z(n)&&(l=!!n.leading,f="maxWait"in n,o=f?G(tt(n.maxWait)||0,e):o,d="trailing"in n?!!n.trailing:d),v.cancel=function(){void 0!==s&&clearTimeout(s),u=0,i=c=r=s=void 0},v.flush=function(){return void 0===s?a:m(X())},v}function Z(t){const e=typeof t;return!!t&&("object"==e||"function"==e)}function tt(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&"[object Symbol]"==V.call(t)}(t))return NaN;if(Z(t)){const e="function"==typeof t.valueOf?t.valueOf():t;t=Z(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(q,"");const e=U.test(t);return e||R.test(t)?J(t.slice(2),e?2:8):P.test(t)?NaN:+t}const et={};const nt=function(t,e,n){let i=!0,r=!0;if("function"!=typeof t)throw new TypeError("Expected a function");return Z(n)&&(i="leading"in n?!!n.leading:i,r="trailing"in n?!!n.trailing:r),Y(t,e,{leading:i,maxWait:e,trailing:r})}((function(){Object.entries(et).forEach((async([t,e])=>{const n=await T(E.u,`data/Following/Avatars/${t}`),i=await n.createWritable();await i.write(e),await i.close(),delete et[t]}))}),7e3);async function it(t,e){const n=await T(E.u,`data/Following/Avatars/${e}`),i=await n.getFile();if(i.size>0){const t=12096e5;if(Date.now()-i.lastModified<t)return}const r=await fetch(t),o=r.headers.get("Content-Type");if("image/jpeg"!==o)return void S(new Error(`avatar type is ${o}`),"daa9","silently");const a=await r.blob();et[e]=a,nt(),e.includes("small")&&await L(200),e.includes("large")&&await L(2e3)}const rt={D:!1},ot=t=>e=>{const n={};for(const i of t)n[i]=e[i];return n},at=t=>e=>{const n={};return e.forEach((e=>{n[e[t]]=e})),n};function st(t){const e=ot(["id","desc","createTime","itemMute"])(t);return e.video=ot(["id","cover","playAddr","downloadAddr","format"])(t.video),e.stats=ot(["diggCount","playCount"])(t.stats),e.author=ot(["id","uniqueId","nickname","avatarLarger"])(t.author),e.authorStats=ot(["followerCount","heartCount","videoCount"])(t.authorStats),e}function ct(t){return ot(["id","uniqueId","nickname","avatarLarger","avatarThumb","signature"])(t.user)}const ut=new class{constructor(){this.I="initial",this.$={}}async j(){if(window.__NEXT_DATA__)try{this.$=window.__NEXT_DATA__.props.initialProps,this.I="next"}catch(t){S(t,"ac26"),this.I="error"}else if(window.SIGI_STATE)try{this.$=window.SIGI_STATE.AppContext.appContext,this.I="sigi"}catch(t){S(t,"ac37"),this.I="error"}else try{const t=await fetch("/node-webapp/api/app-context"),e=await t.json();0===e.statusCode?(this.$=e,this.I="fetched"):(S(new Error(e),"ac49"),this.I="error")}catch(t){S(t,"ac52"),this.I="error"}$.k("app_context",{status:this.I}),this.I}O(){const{$wid:t,$region:e,$os:n,$language:i,$user:r}=this.$;if(!(t&&e&&n&&i))return S(new Error(JSON.stringify({$wid:t,$region:e,$os:n,$language:i})),"ac64"),!1;if(!r)return!0;const{uid:o,uniqueId:a,secUid:s,nickName:c}=r;return!!(o&&a&&s&&c)||(S(new Error(JSON.stringify({uid:o,uniqueId:a,secUid:s,nickName:c})),"ac75"),!1)}};var lt,ft,dt;class ht{constructor(t){return lt.add(this),ft.set(this,void 0),N(this,ft,"likes"===t?new URL("https://m.tiktok.com/api/favorite/item_list/"):new URL("https://m.tiktok.com/api/user/list/"),"f"),W(this,lt,"m",dt).call(this),this}A(t){return W(this,ft,"f").searchParams.set("cursor",t),this}B({maxCursor:t,minCursor:e}){return W(this,ft,"f").searchParams.set("maxCursor",String(t)),W(this,ft,"f").searchParams.set("minCursor",String(e)),this}M(t){return W(this,ft,"f").searchParams.set("count",String(t)),this}W(){return W(this,ft,"f").toString()}}ft=new WeakMap,lt=new WeakSet,dt=function(){const t=Object.assign({},function(){var t;return{aid:"1988",app_name:"tiktok_web",device_platform:"web_pc",referer:document.referrer,cookie_enabled:navigator.cookieEnabled,screen_width:screen.width,screen_height:screen.height,browser_language:navigator.language,browser_platform:navigator.platform,browser_name:navigator.appCodeName,browser_version:navigator.appVersion,browser_online:navigator.onLine,verifyFp:null===(t=document.cookie.match(/s_v_web_id=(\w+)/))||void 0===t?void 0:t[1],timezone_name:Intl.DateTimeFormat().resolvedOptions().timeZone,is_page_visible:!0,focus_state:!0,is_fullscreen:window.matchMedia("(display-mode: fullscreen)").matches,history_len:window.history.length,battery_info:{}}}(),function(){const{$wid:t,$region:e,$language:n,$os:i,$user:r}=ut.$;return{device_id:t,region:e,priority_region:r.region,os:i,app_language:n,secUid:r.secUid,language:n}}());Object.entries(t).forEach((([t,e])=>{W(this,ft,"f").searchParams.set(t,(null==e?void 0:e.toString())||"")}))};const wt=1030,yt=["unset","downloading","paused","capped","completed"],pt=["downloading","completed","capped","pausing","paused","resuming"],mt={N:"unset",L:{F(t){k(16,t)},q(t){k(17,t)}},P:{U(t){b(11,{progress:t})},R(t){pt.includes(t)&&b(11,{status:t}),yt.includes(t)&&(E.l.likes.downloadStatus=t)}}};function vt(t){if(!t)return!1;const e=new URL(t),n=e.searchParams.get("expire")||e.searchParams.get("x-expires");if(!n)return!1;return(Number(n+"000")-Date.now())/1e3/60<30}function gt(t){return[t.video.playAddr,t.video.cover].some(vt)}function kt(t){return t.some(gt)}function bt(t){return{async J(){const e=await m.t,n=await e.get("followingCache",t);return n?kt(n)?[]:n.sort(((t,e)=>t.createTime-e.createTime)):[]},o:async e=>(await m.t).put("followingCache",e,t),async H(t){return(await this.J()).map((t=>t.id)).includes(t.id)}}}function _t(t){const e=at("id")(t),n=t.map((t=>t.id));return[...new Set(n)].map((t=>e[t]))}var St,Tt,Ct,Dt,It;const xt=new(It=class{constructor(){St.add(this),this.I="unset",Tt.set(this,"unset")}async K(){try{if(this.I===(this.I="expanding"))return;const t=await W(this,St,"m",Ct).call(this);if(!t)return S(new Error("cannot find authorList"),"ale63","silently"),b(21),void(this.I="failed");if("A"===t.lastChild.tagName)return void(this.I="expanded");if("unset"===W(this,Tt,"f"))return N(this,Tt,t.lastChild.textContent,"f"),W(this,Tt,"f"),void W(this,St,"m",Dt).call(this,t);if(W(this,Tt,"f")===t.lastChild.textContent)return void W(this,St,"m",Dt).call(this,t);if(t.lastChild.textContent!==W(this,Tt,"f"))return void(this.I="expanded")}catch(t){S(t,"ale92")}}},Tt=new WeakMap,St=new WeakSet,Ct=async function(){let t=document.querySelectorAll(".user-list");0===t.length&&(t=document.querySelectorAll('div[class*="-DivUserContainer"]'));let e=t[t.length-1];if(!e){const n=document.querySelector('a[title="TikTok"]');n&&(n.click(),await L(3e3),t=document.querySelectorAll(".user-list"),0===t.length&&(t=document.querySelectorAll('div[class*="-DivUserContainer"]')),e=t[t.length-1])}return e},Dt=async function(t){for(var e,n;;){if(null===(e=t.lastChild)||void 0===e||e.click(),await L(2e3),"A"===t.lastChild.tagName)return void(this.I="expanded");if((null===(n=t.lastChild)||void 0===n?void 0:n.textContent)!==W(this,Tt,"f"))return void(this.I="expanded")}},It);async function Et(t){for(xt.K();;){const e=document.querySelector(`a[href*="${t}"]`);if(e)return void e.click();if("expanded"===xt.I)throw new Error("Couldn't find the user to click on the left bar. Maybe you just started following this user so it's not on the left bar yet. Reload and try again.");await L(500)}}var $t,jt,Ot;class At{constructor(t,e){this.V=t,this.G=e,$t.add(this),this.X=this.V.id+this.G}get Y(){var t;return"liked"===this.G?Boolean(E.l.likes.downloaded.has(this.V.id)):Boolean(null===(t=E.l.following.downloadLog[this.V.author.id])||void 0===t?void 0:t.has(this.V.id))}Z(){return gt(this.V)}async tt(){M.addNew({createTime:Date.now(),startWritingToDiskTime:0,key:this.X,likedOrFollowing:this.G,itemData:this.V}),await W(this,$t,"m",jt).call(this),await W(this,$t,"m",Ot).call(this)}et(){try{E.l.videos[this.V.id]=function(t,e){const n={authorId:t.author.id,desc:t.desc,createTime:t.createTime,itemMute:t.itemMute,diggCount:t.stats.diggCount,playCount:t.stats.playCount},i=e.videos[t.id];return Object.assign({},i,n)}(this.V,E.l),E.l.authors[this.V.author.id]=function(t,e){const n={uniqueIds:[t.author.uniqueId],nicknames:[t.author.nickname],followerCount:t.authorStats.followerCount,heartCount:t.authorStats.heartCount,videoCount:t.authorStats.videoCount},i=e.authors[t.author.id];i&&(n.uniqueIds=[...new Set([...n.uniqueIds,...i.uniqueIds])],n.nicknames=[...new Set([...n.nicknames,...i.nicknames])]);return Object.assign({},i,n)}(this.V,E.l)}catch(t){S(t,"i77")}}}$t=new WeakSet,jt=async function(){try{const t=await fetch(this.V.video.cover),e=t.headers.get("Content-Type");if("image/jpeg"!==e)throw new Error(`cover type is ${e}`);const n=await t.arrayBuffer();M._(this.X,n)}catch(t){M.C(this.X),"Failed to fetch"===t.message?S(new Error(`fetch failed ${this.V.video.cover}`),"bi60","silently"):S(t,"bi63","silently")}},Ot=async function(){try{const t=await fetch(this.V.video.playAddr||this.V.video.downloadAddr),e=t.headers.get("Content-Type");if("video/mp4"!==e)throw new Error(`video type is ${e}`);const n=t.headers.get("Content-Length"),i=(Number(n)/1024/1024).toFixed(1)+"MB";if(Number(n)>5e7)throw console.error(`video is too large, skip. size: ${i}, url: ${this.V.video.playAddr}`),new Error("video is too large, skip");M.S(this.X,i);const r=await t.arrayBuffer();_("please_resync_this_video",{tempStorageKey:this.X,arrayBuffer:r})}catch(t){M.C(this.X),"Failed to fetch"===t.message?S(new Error(`fetch failed ${this.V.video.playAddr||this.V.video.downloadAddr}`),"bi105","silently"):S(t,"bi108","silently")}};const Bt={nt:!1};var Mt,Wt,Nt,Lt,Ft,qt,Pt;const Ut=new(Pt=class{constructor(){Mt.add(this),Wt.set(this,[]),this.it="",Nt.set(this,null)}async rt(t,e){try{this.it=t,N(this,Wt,[],"f"),document.documentElement.style.overflow="hidden",document.documentElement.style.pointerEvents="none",document.querySelector("aside#myfaveTT-container").style.pointerEvents="auto",await Et(e),await L(2e3),W(this,Mt,"m",Lt).call(this)}catch(t){S(t,"sr48")}}async ot(t){if(0===t.length)return void S(new Error("repeat failed?"),"scr78","silently");const e=function(t){const e=t[0].author.id;if(t.some((t=>t.author.id!==e)))throw new Error("not all videos share the same author");return e}(t);if(e!==this.it)return;if(kt(W(this,Wt,"f")))return W(this,Mt,"m",qt).call(this),Gt.at(e),void(this.it="");W(this,Wt,"f").push(...t),mt.L.F(W(this,Wt,"f").length);if(!await bt(e).H(W(this,Wt,"f")[W(this,Wt,"f").length-1]))return W(this,Wt,"f").length>wt?(N(this,Wt,W(this,Wt,"f").slice(0,wt),"f"),void await this.st()):void 0;await this.st()}async st(){var t;try{if(!this.it)return;const e=this.it;this.it="",W(this,Mt,"m",qt).call(this);const n=await bt(e).J(),i=_t(W(this,Wt,"f").concat(n));await bt(e).o(i),i.length,(t=E.l.following.lastRun)[e]||(t[e]={scroll:0,download:0}),E.l.following.lastRun[e].scroll=Date.now(),E.p(),async function(t){E.l.following.started.add(t);const e=await bt(t).J();for(const[n,i]of e.entries()){for(;Bt.nt;)await L(500);const r=new At(i,"following");if(r.et(),!r.Y){if(r.Z())return void Gt.at(t);mt.L.q({total:e.length,current:n+1}),r.tt().catch((t=>S(t,"doa22","silently"))),await L(O())}}E.l.following.lastRun[t].download=Date.now(),await L(2e3),await Gt.at(t)}(e)}catch(t){S(t,"blf73")}}},Wt=new WeakMap,Nt=new WeakMap,Mt=new WeakSet,Lt=function(){W(this,Nt,"f")&&clearInterval(W(this,Nt,"f")),N(this,Nt,setInterval((()=>W(this,Mt,"m",Ft).call(this)),1e3),"f")},Ft=async function(){try{if("hidden"===document.visibilityState)return;if(!this.it)return;!function(){const{scrollHeight:t,scrollTop:e,clientHeight:n}=document.documentElement;return t-e-n<20}()?window.scrollBy({top:350,left:0,behavior:"smooth"}):(await L(2e3),await this.st())}catch(t){S(t,"fl58")}},qt=function(){clearInterval(W(this,Nt,"f"))},Pt);var Rt,Jt,Ht,zt,Kt,Vt;const Gt=new(Vt=class{constructor(){Rt.add(this),this.ct={},this.ut={alreadyInArchive:[],willAddToArchive:[],notInterested:[]},Jt.set(this,[])}async lt(){try{const t=await async function(){let t=[],[e,n]=[0,0],i=0;do{await L(1e3);const r=new ht("following").B({maxCursor:e,minCursor:n}).M(0===e?10:20);try{const i=await window.fetch(r.W(),{credentials:"include"}),o=await i.json(),{statusCode:a,userList:s}=o;if(0!==a)throw new Error(`Err fetching authors, ${JSON.stringify(o)}`);if(t=(s||[]).concat(t),({maxCursor:e,minCursor:n}=o),b(13,{currentTotal:t.length}),"number"!=typeof e||"number"!=typeof n)throw new Error("Things have changed? Author cursor is no longer number?")}catch(e){if(i++,i<=3)continue;return S(e,"fa43"),t}if(i=0,0===t.length)return[]}while("-1"!==String(e)&&"-1"!==String(n));return t}();if(!rt.D)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");E.v(t),async function(t){for(const e of t){const{id:t,avatarThumb:n}=e.user;try{await it(n,`small_${t}.jpg`)}catch(t){S(t,"daa60","silently")}}for(const e of t){const{id:t,avatarLarger:n}=e.user;try{await it(n,`large_${t}.jpg`)}catch(t){S(t,"daa68","silently")}}}(t);const e=t.map(ct);this.ct=at("id")(e),k(14,{authorDict:this.ct,started:[...E.l.following.started],notInterested:[...E.l.following.notInterested]})}catch(t){S(t,"ff27")}}async ft(t){k(20,"following"),this.ut=t,E.l.following.notInterested=new Set(t.notInterested);const e=[...t.willAddToArchive,...t.alreadyInArchive].sort(((t,e)=>{var n,i;return((null===(n=E.l.following.lastRun[t])||void 0===n?void 0:n.download)||0)-((null===(i=E.l.following.lastRun[e])||void 0===i?void 0:i.download)||0)}));N(this,Jt,e.map((t=>({authorId:t,status:"queued"}))),"f"),await E.p(),await W(this,Rt,"m",Ht).call(this),await W(this,Rt,"m",zt).call(this)}async at(t){try{const e=W(this,Jt,"f").find((e=>e.authorId===t));e&&(e.status="finished"),await E.p(),await W(this,Rt,"m",zt).call(this)}catch(t){S(t,"ff101")}}},Jt=new WeakMap,Rt=new WeakSet,Ht=async function(){for(const t of E.l.following.officialAuthorList)this.ut.alreadyInArchive.includes(t)||this.ut.willAddToArchive.includes(t)||await E.g(t)},zt=async function(){const t=W(this,Jt,"f").find((t=>"queued"===t.status));if(t){t.status="current";const e=this.ct[t.authorId].uniqueId;await Ut.rt(t.authorId,e),k(15,W(this,Jt,"f"))}else W(this,Rt,"m",Kt).call(this)},Kt=function(){const{officialAuthorList:t,started:e,notInterested:n}=E.l.following;k(18,{numFollowed:t.size,numStarted:e.size,numNotInterested:n.size,numCappedOut:[...t].filter((t=>!e.has(t))).filter((t=>!n.has(t))).length})},Vt),Qt=new class{constructor(){this.dt={}}o(t){this.dt=t}};function Xt(){try{return F(Qt.dt.unlocks.likeLevel).cap}catch(t){return S(t,"ud17"),0}}function Yt(){return Qt.dt.profile.uid}const Zt={async i(){const t=await m.t;return await t.get("likesCache",Yt())||[]},o:async t=>(await m.t).put("likesCache",t,Yt()),async ht(){kt(await this.i())&&await this.o([])},async H(t){return(await this.i()).map((t=>t.id)).includes(t.id)}};function te(t){if(!t.id||!t.video||!t.author)return S(new Error(JSON.stringify(t)),"pid27","silently"),!1;if(!t.video.downloadAddr&&!t.video.playAddr)return S(new Error("no video addr"),"pid11","silently"),!1;if(!t.video.cover)return S(new Error(JSON.stringify(t.video)),"pid39","silently"),!1;if(t.id!==t.video.id)return S(new Error(`${t.id} different from ${t.video.id}`),"pid49","silently"),!1;if("mp4"!==t.video.format)return S(new Error(`video format is ${t.video.format}`),"pid56","silently"),!1;if(!t.video.cover.includes("tiktokcdn"))return S(new Error(`Cover url not in tiktokcdn: ${t.video.cover}`),"pid79","silently"),!1;{const e=new URL(t.video.cover),n=e.searchParams.get("expire")||e.searchParams.get("x-expires");if(!n||10!==n.length)return S(new Error(`cover url no exp: ${t.video.cover}`),"pid100","silently"),!1}return!0}async function ee(){const t=await async function(){const t=[];let e="0",n=!0,i=0,r=0;await Zt.ht();do{await L(1e3);const o=new ht("likes").A(e).M(30);let a=[],s={};try{const t=await window.fetch(o.W(),{credentials:"include"});if(s=await t.json(),a=s.itemList,0!==s.statusCode)throw new Error(`status_code: ${s.statusCode}`)}catch(t){if(i++,i<=3)continue;if(!s.cursor||s.cursor===e)return S(t,"fl53"),"error"}if(i=0,a){let e=a.map(st);if(e.some((t=>!te(t)))&&(r++,r<=3))continue;if(r=0,e=a.filter(te),0===e.length&&a.length>10)return S(new Error("tiktok api changed, wait for the next patch of this extension to fix"),"fl76"),[];t.push(...e),b(9,{currentTotal:t.length})}if(0===t.length)return[];if(await Zt.H(t[t.length-1]))break;if(({cursor:e,hasMore:n}=s),"-1"===String(e)||"0"===String(e)||!e){S(new Error(`weird cursor: ${e}`),"fl76","silently");break}}while(n);return t}();if("error"===t)return;const e=await Zt.i(),n=_t(t.concat(e));await Zt.o(n)}var ne,ie,re,oe,ae,se,ce,ue,le;const fe=new(le=class{constructor(){ne.add(this),ie.set(this,[]),re.set(this,!1),oe.set(this,0)}async wt(){N(this,re,!0,"f"),await L(1e3),mt.P.R("paused"),E.p()}async yt(){N(this,re,!1,"f")}async vt(){var t;await W(this,ne,"m",se).call(this);try{if(0===W(this,ie,"f").length)return void b(10);if(!rt.D)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");E.l.likes.officialList=W(this,ie,"f").map((t=>t.id));const{finalDownloadOutcome:e}=await W(this,ne,"m",ce).call(this);if("someUrlExpired"===e)return N(this,oe,1+(t=+W(this,oe,"f")),"f"),t>3?void S(new Error("Session too long, please reload"),"bl46"):void this.vt();W(this,ne,"m",ue).call(this,e)}catch(t){S(t,"bl50")}}},ie=new WeakMap,re=new WeakMap,oe=new WeakMap,ne=new WeakSet,ae=function(){return E.l.likes.downloaded.size>=Xt()},se=async function(){try{await ee(),E.l.likes.lastRun.collect=Date.now(),N(this,ie,await Zt.i(),"f")}catch(t){throw S(t,"bl32"),t}},ce=async function(){k(20,"likes"),mt.P.U({total:W(this,ie,"f").length,nowAt:0});for(const t of W(this,ie,"f")){new At(t,"liked").et()}for(const[t,e]of W(this,ie,"f").reverse().entries()){const n=new At(e,"liked");if(!n.Y){if(W(this,ne,"m",ae).call(this))return{finalDownloadOutcome:"capped"};for(;W(this,re,"f");)await L(1e3);if(n.Z())return{finalDownloadOutcome:"someUrlExpired"};mt.P.R("downloading"),mt.P.U({total:W(this,ie,"f").length,nowAt:t+1}),n.tt().catch((t=>S(t,"bl75","silently"))),W(this,re,"f")||await L(O())}}return{finalDownloadOutcome:"completed"}},ue=async function(t){const e={officialListLength:E.l.likes.officialList.length,numMp4InLocalFolder:E.l.likes.downloaded.size,status:t};E.l.likes.lastRun.download=Date.now(),await L(200),b(12,e),mt.P.R(t),await E.p()},le);function de(t){b(6,t)}let he=!1;var we,ye,pe,me,ve,ge;const ke=new(ge=class{constructor(){we.add(this),ye.set(this,null)}async gt(){const t=await v.i("archiveFolderHandle"),e=await showDirectoryPicker({startIn:t});W(this,we,"m",pe).call(this,e)}kt(){b(5)}},ye=new WeakMap,we=new WeakSet,pe=async function(t){if("granted"!==await t.requestPermission({mode:"readwrite"}))return;if(!await async function(t){if(await async function(t){const e=[];for await(const n of t.keys())e.push(n);return 0===e.length}(t))return!!he||(he=!0,!Qt.dt.behavior.hasCreatedArchiveFolder||(de({dropResult:"unexpectedly_empty"}),!1));try{await t.getFileHandle("Archive.html");const e=await t.getDirectoryHandle("data"),n=await e.getDirectoryHandle(".appdata");return await n.getFileHandle("app.js"),!0}catch(t){return de({dropResult:"content_seems_wrong"}),!1}}(t))return;const e=await async function(t){const e=await T(t,"data/.appdata/db.js"),n=await e.getFile(),i=x(await n.text()),{id:r,uid:o,uniqueId:a,nickname:s}=Qt.dt.profile;return i.user.id.length>0&&i.user.id!==r?(de({dropResult:"belongs_to_another_tiktok_account",belongsToUser:i.user.uniqueId}),null):(i.user={uid:o,id:r,uniqueId:a,nickname:s},i)}(t);e&&W(this,we,"m",me).call(this,t,e)},me=async function(t,e){rt.D||_("is_resync_ready"),k(7),await E.h(t,e),"following"===mt.N?Gt.lt():fe.vt(),W(this,we,"m",ve).call(this)},ve=function(){var t;null===(t=W(this,ye,"f"))||void 0===t||t.remove(),N(this,ye,null,"f")},ge);function be(){var e;null===(e=document.getElementById("myfaveTT-container"))||void 0===e||e.remove(),document.body.classList.remove("pushed-by-myfaveTT"),t.onmessage=null,t.close(),window.removeEventListener("message",Te)}let _e="";async function Se(e){try{const{type:n,payload:i}=e.data;if(0===n)return void t.postMessage({type:1});if(1===n)return be(),void alert("Not loading myFaveTT sidebar, because it's already running in another tab.");if(100===n)return k(3,i),void xt.K();if(102===n)return void k(19,i);if(101===n){if(!Ut.it)return;if(_e===(_e=JSON.stringify(e.data)))return void console.error("double listener?!");try{const t=await async function(t){const{url:e,requestHeaders:n}=t,i=n.find((t=>"x-tt-params"===t.name));if(!i)return[];const r={[i.name]:i.value,Accept:"application/json, text/plain, text/csv, */*"};let o=0,a=0;for(;;){await L(1e3);const t=await fetch(e,{headers:r,credentials:"include"}),n=await t.json(),{statusCode:i,itemList:s}=n;if(0!==i){if(o++,o<=3)continue;return S(new Error(`Err in repeat captured request, ${JSON.stringify(n)}`),"bf31","silently"),[]}if(!s)return[];let c=s.map(st);if(c.some((t=>!te(t)))){if(a++,a<=3)continue;S(new Error("still flawed"),"bf45","silently")}if(c=c.filter(te),s.length>10&&0===c.length)throw S(new Error(JSON.stringify(st(s[0]))),"rp58","silently"),new Error("tiktok api changed, wait for the next patch of this extension to fix");return c}}(i);await Ut.ot(t)}catch(t){S(t,"om82","silently")}}}catch(t){S(t,"om41")}}async function Te(e){try{const{origin:n,data:{type:i,payload:r}}=e;if(n!==g)return;switch(i){case"reload":location.href="https://www.tiktok.com";break;case"resync_is_ready":rt.D=!0;break;case"resynced":{const{tempStorageKey:t,arrayBuffer:e}=r;M.T(t,e);break}case 12:ke.gt();break;case 1:try{mt.N="likes",E.u?fe.vt():ke.kt()}catch(t){S(t,"om46")}break;case 2:try{mt.N="following",E.u?Gt.lt():ke.kt()}catch(t){S(t,"om55")}break;case 3:be();break;case 4:E.m(r);break;case 0:if(b(0,"1.2.45"),"initial"===ut.I){if(await ut.j(),"error"===ut.I)break;if(!ut.O())break}b(4,function(){const t=ut.$.$user;return{id:(null==t?void 0:t.uid)||null,secUid:(null==t?void 0:t.secUid)||null,uniqueId:(null==t?void 0:t.uniqueId)||null,nickname:(null==t?void 0:t.nickName)||null}}()),function(e,n){t.postMessage({type:e,payload:n})}(2);break;case 5:fe.wt();break;case 6:fe.yt();break;case 10:Bt.nt=!0;break;case 11:Bt.nt=!1;break;case 7:Qt.o(r);break;case 8:try{Gt.ft(r)}catch(t){S(t,"om161")}break;case 9:Et(r);break;case 13:location.href="https://www.tiktok.com";break;case 14:location.href="https://chrome.google.com/webstore/detail/myfavett/gmajiifkcmjkehmngbopoobeplhoegad"}}catch(t){S(t,"om136")}}try{t.onmessage=Se,window.removeEventListener("message",Te),window.addEventListener("message",Te),t.postMessage({type:0})}catch(t){S(t,"st8")}
