const e="chrome-extension://gmajiifkcmjkehmngbopoobeplhoegad",t=new BroadcastChannel("myfaveTT");function i(t,i){ui.postMessage({type:t,payload:i},e)}const n=i;function o(t,i){ui.postMessage({type:t,payload:i},e)}function r(e,i){t.postMessage({type:e,payload:i})}function a(e,t,n){i(1,{err:e,location:t,silently:n,fromChromeExtensionVersion:"1.1.6"})}const s={schemaVersion:1,user:{uid:"",id:"",uniqueId:"",nickname:""},authors:{},videos:{},likes:{downloadStatus:"unset",officialList:[],downloaded:new Set,lastRun:{collect:0,download:0}},following:{officialAuthorList:new Set,started:new Set,notInterested:new Set,downloadLog:{},lastRun:{}}};function c(e){return t=function(e){return JSON.stringify(e,(function(e,t){return t instanceof Set?[...t]:"string"==typeof t?t.replaceAll("`","èƒŒð“„¹å‰ƒ").replaceAll("${","â‘€â¦ƒ"):t}))}(e),"db=String.raw`{}`;".slice(0,"db=String.raw`{}`;".indexOf("{"))+t+"db=String.raw`{}`;".slice("db=String.raw`{}`;".lastIndexOf("}")+1);var t}function l(e){return""===e?s:function(e){const t=JSON.parse(e,(function(e,t){switch(e){case"downloaded":case"notInterested":case"started":case"officialAuthorList":if(Array.isArray(t))return new Set(t)}return"string"==typeof t?t.replaceAll("â‘€â¦ƒ","${").replaceAll("èƒŒð“„¹å‰ƒ","`"):t}));for(const[e,i]of Object.entries(t.following.downloadLog))t.following.downloadLog[e]=new Set(i);return t}(function(e){const t=e.indexOf("{"),i=e.lastIndexOf("}")-e.length+1;return e.slice(t,i)}(e))}async function d(e,t){try{const i=t.split("/"),n=i.pop();let o=e;for(const e of i)o=await o.getDirectoryHandle(e,{create:!0});return await o.getFileHandle(n,{create:!0})}catch(e){throw a(e,"gfh29"),e}}async function u(e,t){const i=await e.createWritable();await i.write(t),await i.close()}const f=new class{constructor(){this.t=null,this.i=null}async o(e,t){this.t=e,this.i=t,i(8)}async l(){u(await d(this.t,"data/.appdata/db.js"),c(this.i))}async u(e){try{const{archiveHtml:t,appJs:i}=e;u(await d(this.t,"Archive.html"),t),u(await d(this.t,"data/.appdata/app.js"),i)}catch(e){a(e,"a58")}}h(e){e.forEach((e=>{const{id:t,uniqueId:i,nickname:n,signature:o}=e.user,{followerCount:r,videoCount:a,heartCount:s}=e.stats,c={uniqueIds:[i],nicknames:[n],followerCount:r,heartCount:s,videoCount:a,signature:o},l=this.i.authors[t];l&&(c.uniqueIds=[...new Set([i,...l.uniqueIds])],c.nicknames=[...new Set([n,...l.nicknames])]),this.i.authors[t]=c})),this.i.following.officialAuthorList=new Set(e.map((e=>e.user.id))),this.l()}async p(e){try{if(!this.i.following.started.has(e)&&!this.i.following.downloadLog[e])return;this.i.following.started.delete(e),delete this.i.following.downloadLog[e],await this.l();let t=await this.t.getDirectoryHandle("data");t=await t.getDirectoryHandle("Following"),t=await t.getDirectoryHandle(e),await t.removeEntry("videos",{recursive:!0})}catch(e){a(e,"purge failed","silently")}}};function h(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)}function w(e,t,i,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(e,i):o?o.value=i:t.set(e,i),i}const p=new Set(["BIF","CLP","DJF","GNF","JPY","KMF","KRW","MGA","PYG","RWF","UGX","VND","VUV","XAF","XOF","XPF"]);function y(e){return new Promise((t=>{setTimeout((()=>{t(e)}),e)}))}function g(e){const t=5e3,i={unlocked:["unlock_0_to_1000_likes(free)"],cap:1e3,nextToBuy:"unlock_1001_to_5000_likes",lineItemDescription:'"Enable downloading more than 1000, up to 5000 videos from your Likes on TikTok."'};if(0===e)return i;const n=[i.unlocked[0]],o=t*e,r=o+t,a=`unlock_${o+1}_to_${r}_likes`,s=`"Enable downloading more than ${o}, up to ${r} videos from your Likes on TikTok."`;for(let t=0;t<e;t++)n.push(g(t)?.nextToBuy);return{unlocked:n,cap:o,nextToBuy:a,lineItemDescription:s}}async function m(e,t){const i=await fetch(e),n=i.headers.get("Content-Type");"image/jpeg"!==n&&a(new Error(`avatar type is ${n}`),"daa9");const o=await i.blob(),r=await d(f.t,`data/Following/${t}`),s=await r.createWritable();await s.write(o),await s.close()}Object.entries({USD:{description:"US Dollar",countryCode:"US",localeCode:"en-us",stripePrice:973,localizedPriceTag:""},EUR:{description:"Euro",countryCode:"EU",localeCode:"en-gb",stripePrice:783,localizedPriceTag:""},GBP:{description:"British Pound",countryCode:"GB",localeCode:"en-gb",stripePrice:683,localizedPriceTag:""},CAD:{description:"Canadian Dollar",countryCode:"CA",localeCode:"en",stripePrice:1170,localizedPriceTag:""},AUD:{description:"Australian Dollar",countryCode:"AU",localeCode:"en",stripePrice:1370,localizedPriceTag:""},KRW:{description:"South Korean Won",countryCode:"KR",localeCode:"ko",stripePrice:11700,localizedPriceTag:""},JPY:{description:"Japanese Yen",countryCode:"JP",localeCode:"ja",stripePrice:1070,localizedPriceTag:""},RUB:{description:"Russian Ruble",countryCode:"RU",localeCode:"ru",stripePrice:67300,localizedPriceTag:""},INR:{description:"Indian Rupee",countryCode:"IN",localeCode:"en-in",stripePrice:67300,localizedPriceTag:""},BRL:{description:"Brazilian Real",countryCode:"BR",localeCode:"pt-br",stripePrice:4400,localizedPriceTag:""},ILS:{description:"Israeli New Shekel",countryCode:"IL",localeCode:"en",stripePrice:2730,localizedPriceTag:""},PHP:{description:"Philippine Piso",countryCode:"PH",localeCode:"en",stripePrice:43700,localizedPriceTag:""},PLN:{description:"Polish Zloty",countryCode:"PL",localeCode:"pl",stripePrice:3730,localizedPriceTag:""},IDR:{description:"Indonesian Rupiah",countryCode:"ID",localeCode:"in",stripePrice:137e5,localizedPriceTag:""},MXN:{description:"Mexican Peso",countryCode:"MX",localeCode:"en",stripePrice:17300,localizedPriceTag:""},CNY:{description:"Chinese Yuan",countryCode:"CN",localeCode:"en",stripePrice:4730,localizedPriceTag:""},HKD:{description:"Hong Kong Dollar",countryCode:"HK",localeCode:"zh-HK",stripePrice:7700,localizedPriceTag:""},TWD:{description:"New Taiwan Dollar",countryCode:"TW",localeCode:"zh",stripePrice:27300,localizedPriceTag:""},MYR:{description:"Malaysian Ringgit",countryCode:"MY",localeCode:"ms",stripePrice:3700,localizedPriceTag:""},NZD:{description:"New Zealand Dollar",countryCode:"NZ",localeCode:"en",stripePrice:1370,localizedPriceTag:""},CHF:{description:"Swiss Franc",countryCode:"CH",localeCode:"en",stripePrice:873,localizedPriceTag:""},SGD:{description:"Singapore Dollar",countryCode:"SG",localeCode:"en",stripePrice:1370,localizedPriceTag:""},UAH:{description:"Ukrainian Hryvnia",countryCode:"UA",localeCode:"uk",stripePrice:23700,localizedPriceTag:""},ARS:{description:"Argentine Peso",countryCode:"AR",localeCode:"es",stripePrice:97700,localizedPriceTag:""},ZAR:{description:"South African Rand",countryCode:"ZA",localeCode:"en",stripePrice:13700,localizedPriceTag:""},NOK:{description:"Norwegian Krone",countryCode:"NO",localeCode:"no",stripePrice:8700,localizedPriceTag:""},SEK:{description:"Swedish Krona",countryCode:"SE",localeCode:"sv",stripePrice:7700,localizedPriceTag:""},DKK:{description:"Danish Krone",countryCode:"DK",localeCode:"da",stripePrice:5700,localizedPriceTag:""},VND:{description:"Vietnamese dong",countryCode:"VN",localeCode:"vi",stripePrice:197300,localizedPriceTag:""}}).forEach((([e,t])=>{const i=p.has(e)?t.stripePrice:t.stripePrice/100;t.localizedPriceTag=new Intl.NumberFormat(t.localeCode,{style:"currency",useGrouping:!1,currency:e}).format(i)}));const v=e=>t=>{const i={};for(const n of e)i[n]=t[n];return i},C=e=>t=>{const i={};return t.forEach((t=>{i[t[e]]=t})),i};function _(e){const t=v(["id","desc","createTime","itemMute"])(e);return t.video=v(["id","cover","dynamicCover","playAddr","downloadAddr","format"])(e.video),t.stats=v(["diggCount","playCount"])(e.stats),t.author=v(["id","uniqueId","nickname","avatarLarger"])(e.author),t.authorStats=v(["followerCount","heartCount","videoCount"])(e.authorStats),t}function k(e){return v(["id","uniqueId","nickname","avatarLarger","avatarThumb","signature"])(e.user)}const b={g(e,t){i(2,{event:e,params:t})}},P=new class{constructor(){this.m="initial",this.v={}}async C(){if(window.__NEXT_DATA__)try{this.v=window.__NEXT_DATA__.props.initialProps,this.m="next"}catch(e){a(e,"ac26"),this.m="error"}else if(window.SIGI_STATE)try{this.v=window.SIGI_STATE.AppContext.appContext,this.m="sigi"}catch(e){a(e,"ac37"),this.m="error"}else try{const e=await fetch("/node-webapp/api/app-context"),t=await e.json();0===t.statusCode?(this.v=t,this.m="fetched"):(a(new Error(t),"ac49"),this.m="error")}catch(e){a(e,"ac52"),this.m="error"}b.g("app_context",{status:this.m}),this.m}_(){const{$wid:e,$region:t,$os:i,$language:n,$user:o}=this.v;if(!(e&&t&&i&&n))return a(new Error(JSON.stringify({$wid:e,$region:t,$os:i,$language:n})),"ac64"),!1;if(!o)return!0;const{uid:r,region:s,uniqueId:c,secUid:l,nickName:d}=o;return!!(r&&s&&c&&l&&d)||(a(new Error(JSON.stringify({uid:r,region:s,uniqueId:c,secUid:l,nickName:d})),"ac75"),!1)}};var T,D,S;class I{constructor(e){return T.add(this),D.set(this,void 0),w(this,D,"likes"===e?new URL("https://m.tiktok.com/api/favorite/item_list/"):new URL("https://m.tiktok.com/api/user/list/"),"f"),h(this,T,"m",S).call(this),this}k(e){return h(this,D,"f").searchParams.set("cursor",e),this}P({maxCursor:e,minCursor:t}){return h(this,D,"f").searchParams.set("maxCursor",String(e)),h(this,D,"f").searchParams.set("minCursor",String(t)),this}T(e){return h(this,D,"f").searchParams.set("count",String(e)),this}D(){return h(this,D,"f").toString()}}D=new WeakMap,T=new WeakSet,S=function(){const e=Object.assign({},function(){var e;return{aid:"1988",app_name:"tiktok_web",device_platform:"web_pc",referer:document.referrer,cookie_enabled:navigator.cookieEnabled,screen_width:screen.width,screen_height:screen.height,browser_language:navigator.language,browser_platform:navigator.platform,browser_name:navigator.appCodeName,browser_version:navigator.appVersion,browser_online:navigator.onLine,verifyFp:null===(e=document.cookie.match(/s_v_web_id=(\w+)/))||void 0===e?void 0:e[1],timezone_name:Intl.DateTimeFormat().resolvedOptions().timeZone,is_page_visible:!0,focus_state:!0,is_fullscreen:window.matchMedia("(display-mode: fullscreen)").matches,history_len:window.history.length,battery_info:{}}}(),function(){const{$wid:e,$region:t,$language:i,$os:n,$user:o}=P.v;return{device_id:e,region:t,priority_region:o.region,os:n,app_language:i,secUid:o.secUid,language:i}}());Object.entries(e).forEach((([e,t])=>{h(this,D,"f").searchParams.set(e,(null==t?void 0:t.toString())||"")}))};const E=["unset","downloading","paused","capped","completed"],$=["downloading","completed","capped","pausing","paused","resuming"],A={S:"unset",I:{$(e,t){i(16,{authorId:e,progress:t}),r("scroll_progress",t)},A(){r("enough_scrolling")},B(e){r("download_progress",`${e.current} / ${e.total}`)}},N:{R(e){n(11,{progress:e})},M(e){$.includes(e)&&n(11,{status:e}),E.includes(e)&&(f.i.likes.downloadStatus=e)}}};function B(e){if(!e)return!1;const t=new URL(e),i=t.searchParams.get("expire")||t.searchParams.get("x-expires");if(!i||10!==i.length)throw new Error("url schema changed?");return(Number(i+"000")-Date.now())/1e3/60<10}function z(e){return[e.video.playAddr,e.video.cover,e.video.dynamicCover].some(B)}function N(e){return e.some(z)}let x,R;const M=new WeakMap,O=new WeakMap,j=new WeakMap,L=new WeakMap,W=new WeakMap;let U={get(e,t,i){if(e instanceof IDBTransaction){if("done"===t)return O.get(e);if("objectStoreNames"===t)return e.objectStoreNames||j.get(e);if("store"===t)return i.objectStoreNames[1]?void 0:i.objectStore(i.objectStoreNames[0])}return H(e[t])},set:(e,t,i)=>(e[t]=i,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function F(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(R||(R=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(V(this),t),H(M.get(this))}:function(...t){return H(e.apply(V(this),t))}:function(t,...i){const n=e.call(V(this),t,...i);return j.set(n,t.sort?t.sort():[t]),H(n)}}function K(e){return"function"==typeof e?F(e):(e instanceof IDBTransaction&&function(e){if(O.has(e))return;const t=new Promise(((t,i)=>{const n=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",r),e.removeEventListener("abort",r)},o=()=>{t(),n()},r=()=>{i(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",o),e.addEventListener("error",r),e.addEventListener("abort",r)}));O.set(e,t)}(e),t=e,(x||(x=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>t instanceof e))?new Proxy(e,U):e);var t}function H(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,i)=>{const n=()=>{e.removeEventListener("success",o),e.removeEventListener("error",r)},o=()=>{t(H(e.result)),n()},r=()=>{i(e.error),n()};e.addEventListener("success",o),e.addEventListener("error",r)}));return t.then((t=>{t instanceof IDBCursor&&M.set(t,e)})).catch((()=>{})),W.set(t,e),t}(e);if(L.has(e))return L.get(e);const t=K(e);return t!==e&&(L.set(e,t),W.set(t,e)),t}const V=e=>W.get(e);const q=["get","getKey","getAll","getAllKeys","count"],J=["put","add","delete","clear"],G=new Map;function Y(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(G.get(t))return G.get(t);const i=t.replace(/FromIndex$/,""),n=t!==i,o=J.includes(i);if(!(i in(n?IDBIndex:IDBObjectStore).prototype)||!o&&!q.includes(i))return;const r=async function(e,...t){const r=this.transaction(e,o?"readwrite":"readonly");let a=r.store;return n&&(a=a.index(t.shift())),(await Promise.all([a[i](...t),o&&r.done]))[0]};return G.set(t,r),r}U=(e=>({...e,get:(t,i,n)=>Y(t,i)||e.get(t,i,n),has:(t,i)=>!!Y(t,i)||e.has(t,i)}))(U);const Z={O:function(e,t,{blocked:i,upgrade:n,blocking:o,terminated:r}={}){const a=indexedDB.open(e,t),s=H(a);return n&&a.addEventListener("upgradeneeded",(e=>{n(H(a.result),e.oldVersion,e.newVersion,H(a.transaction))})),i&&a.addEventListener("blocked",(()=>i())),s.then((e=>{r&&e.addEventListener("close",(()=>r())),o&&e.addEventListener("versionchange",(()=>o()))})).catch((()=>{})),s}("myfaveTT",1,{upgrade(e,t,i,n){switch(t){case 0:e.createObjectStore("likesCache"),e.createObjectStore("followingCache")}}})};function X(e){return{async j(){const t=await Z.O,i=await t.get("followingCache",e);return i?N(i)?[]:i.sort(((e,t)=>e.createTime-t.createTime)):[]},L:async t=>(await Z.O).put("followingCache",t,e),async W(e){return(await this.j()).map((e=>e.id)).includes(e.id)}}}function Q(e){const t=C("id")(e),i=e.map((e=>e.id));return[...new Set(i)].map((e=>t[e]))}const ee={};async function te(){const e=[];Object.entries(ee).forEach((async([t,i])=>{const{createTime:n,cover:o,dynamicCover:r,video:s}=i;if(Boolean(o&&r&&s))e.push(async function(e){var t;const{startWritingToDiskTime:i,key:n,likedOrFollowing:o,itemData:{id:r,author:s},cover:c,dynamicCover:l,video:h,size:w}=e;if(0!==i){return Date.now()-i<1e4?void 0:(delete ee[n],void b.g("stuck in writing"))}e.startWritingToDiskTime=Date.now();try{const e="liked"===o?"data/Likes":`data/Following/${s.id}`,i=`${e}/covers/${r}.jpg`,a=`${e}/animated-covers/${r}.webp`,p=`${e}/videos/${r}.mp4`,y=d(f.t,i).then((e=>u(e,c))),g=d(f.t,a).then((e=>u(e,l))),m=d(f.t,p).then((e=>u(e,h)));if(await Promise.all([y,g,m]),f.i.videos[r].size=w,"following"===o){const e=f.i.following.downloadLog;e[t=s.id]||(e[t]=new Set),e[s.id].add(r)}else f.i.likes.downloaded.add(r)}catch(e){a(e,"ts71","silently")}finally{delete ee[n],Object.keys(ee).length}}(i));else{Date.now()-n>3e4&&(delete ee[t],b.g("took over 30 seconds"))}})),e.length&&(await Promise.allSettled(e),await f.l())}const ie=new class{addNew(e){ee[e.key]=e}U(e,t){ee[e].cover=t}F(e,t){ee[e].dynamicCover=t}K(e,t){ee[e].size=t}H(e,t){ee[e]&&(ee[e].video=t,te())}};var ne,oe,re,ae,se,ce,le;class de{constructor(e,t){this.V=e,this.q=t,ne.add(this),this.J=this.V.id+this.q}get G(){var e;return"liked"===this.q?Boolean(f.i.likes.downloaded.has(this.V.id)):Boolean(null===(e=f.i.following.downloadLog[this.V.author.id])||void 0===e?void 0:e.has(this.V.id))}Y(){return z(this.V)}async Z(){ie.addNew({createTime:Date.now(),startWritingToDiskTime:0,key:this.J,likedOrFollowing:this.q,itemData:this.V}),await h(this,ne,"m",oe).call(this),await h(this,ne,"m",re).call(this),await h(this,ne,"m",ae).call(this)}X(){try{f.i.videos[this.V.id]=function(e,t){const i={authorId:e.author.id,desc:e.desc,createTime:e.createTime,itemMute:e.itemMute,diggCount:e.stats.diggCount,playCount:e.stats.playCount},n=t.videos[e.id];return Object.assign({},n,i)}(this.V,f.i),f.i.authors[this.V.author.id]=function(e,t){const i={uniqueIds:[e.author.uniqueId],nicknames:[e.author.nickname],followerCount:e.authorStats.followerCount,heartCount:e.authorStats.heartCount,videoCount:e.authorStats.videoCount},n=t.authors[e.author.id];n&&(i.uniqueIds=[...new Set([...i.uniqueIds,...n.uniqueIds])],i.nicknames=[...new Set([...i.nicknames,...n.nicknames])]);return Object.assign({},n,i)}(this.V,f.i)}catch(e){a(e,"i77")}}}ne=new WeakSet,oe=async function(){const e=await fetch(this.V.video.cover),t=e.headers.get("Content-Type");if("image/jpeg"!==t)throw new Error(`cover type is ${t}`);const i=await e.arrayBuffer();ie.U(this.J,i)},re=async function(){const e=await fetch(this.V.video.dynamicCover),t=e.headers.get("Content-Type");if("image/webp"!==t)throw new Error(`animated cover is ${t}`);const i=await e.arrayBuffer();ie.F(this.J,i)},ae=async function(){const e=await fetch(this.V.video.playAddr),t=e.headers.get("Content-Type");if("video/mp4"!==t)throw new Error(`video type is ${t}`);const i=e.headers.get("Content-Length");ie.K(this.J,(Number(i)/1024/1024).toFixed(1)+"MB");const n=await e.arrayBuffer();o("please_resync_this_video",{tempStorageKey:this.J,arrayBuffer:n})};const ue=new(le=class{constructor(){se.set(this,[]),ce.set(this,"unset")}ee(e){w(this,ce,e,"f"),w(this,se,[],"f"),i(15,e)}te(){i(17),w(this,ce,"unset","f"),w(this,se,[],"f")}async ie(e){const t=function(e){const t=e[0].author.id;if(e.some((e=>e.author.id!==t)))throw new Error("not all videos share the same author");return t}(e);if(t!==h(this,ce,"f"))return;if(h(this,se,"f").push(...e),A.I.$(h(this,ce,"f"),h(this,se,"f").length),h(this,se,"f").length>1e3)return void this.ne();await X(t).W(h(this,se,"f")[h(this,se,"f").length-1])&&this.ne()}async ne(){var e,t;A.I.A(),h(this,se,"f").length;const i=await X(h(this,ce,"f")).j(),n=Q(h(this,se,"f").concat(i));await X(h(this,ce,"f")).L(n),h(this,ce,"f"),n.length,(e=f.i.following.lastRun)[t=h(this,ce,"f")]||(e[t]={scroll:0,download:0}),f.i.following.lastRun[h(this,ce,"f")].scroll=Date.now(),f.l(),await y(2e3);try{!async function(e){f.i.following.started.add(e);const t=await X(e).j();for(const[e,i]of t.entries()){const n=new de(i,"following");n.X(),n.G||(A.I.B({total:t.length,current:e+1}),n.Z().catch((e=>a(e,"doa22","silently"))),await y(6e3))}me.oe(e)}(h(this,ce,"f"))}catch(e){a(e,"blf73")}}},se=new WeakMap,ce=new WeakMap,le);var fe,he,we,pe,ye,ge;const me=new(ge=class{constructor(){fe.add(this),this.re={ae:[],se:[],ce:[]},he.set(this,{})}async le(){const e=await async function(){let e=[],[t,i]=[0,0],o=0;do{await y(1e3);const r=new I("following").P({maxCursor:t,minCursor:i}).T(0===t?10:20);try{const o=await window.fetch(r.D(),{credentials:"include"}),a=await o.json(),{statusCode:s,userList:c}=a;if(0!==s)throw new Error("bad res");if(e=(c||[]).concat(e),({maxCursor:t,minCursor:i}=a),n(13,{currentTotal:e.length}),"number"!=typeof t||"number"!=typeof i)throw new Error("Things have changed? Author cursor is no longer number?")}catch(t){if(o++,o<=3)continue;return a(t,"ff30"),e}if(o=0,0===e.length)return[]}while("-1"!==String(t)&&"-1"!==String(i));return e}();try{f.h(e),async function(e){for(const t of e){const{id:e,avatarThumb:i}=t.user;console.log("fetch avatar:",e),await m(i,`${e}/avatar_small.jpg`),await y(100)}for(const t of e){const{id:e,avatarLarger:i}=t.user;await m(i,`${e}/avatar_large.jpg`),await y(2e3)}}(e)}catch(e){a(e,"ff27")}const t=e.map(k);i(14,{authorDict:C("id")(t),started:[...f.i.following.started],notInterested:[...f.i.following.notInterested]})}async de(e){this.re=e,f.i.following.notInterested=new Set(e.ce),[...e.se.sort(),...e.ae.sort()].forEach((e=>{h(this,he,"f")[e]="queued"})),await f.l(),await h(this,fe,"m",we).call(this),h(this,fe,"m",pe).call(this)}async oe(e){f.i.following.lastRun[e].download=Date.now(),await f.l(),h(this,he,"f")[e]="finished",h(this,fe,"m",pe).call(this)}},he=new WeakMap,fe=new WeakSet,we=async function(){for(const e of f.i.following.officialAuthorList)this.re.ae.includes(e)||this.re.se.includes(e)||await f.p(e)},pe=function(){const e=Object.entries(h(this,he,"f")).filter((([e,t])=>"queued"===t)).map((([e,t])=>e)).shift();e?(h(this,he,"f")[e]="current",ue.ee(e)):h(this,fe,"m",ye).call(this)},ye=function(){console.log("all done!")},ge);function ve(e){return e.id&&e.video&&e.author?e.video.downloadAddr?e.video.playAddr?e.video.cover?!!e.video.dynamicCover&&(e.id!==e.video.id?(a(new Error(`${e.id} different from ${e.video.id}`),"pid49","silently"),!1):"mp4"!==e.video.format?(a(new Error(`video format is ${e.video.format}`),"pid56","silently"),!1):e.video.downloadAddr!==e.video.playAddr?(a(new Error(`downloadAddr ${e.video.downloadAddr} different from playAddr ${e.video.playAddr}`),"pid65","silently"),!1):e.video.playAddr.includes(".tiktok.com")?e.video.cover.includes(".tiktokcdn.com")?!!e.video.dynamicCover.includes(".tiktokcdn.com")||(a(new Error(`Gif url not in tiktokcdn.com: ${e.video.dynamicCover}`),"pid86","silently"),!1):(a(new Error(`Cover url not in tiktokcdn.com: ${e.video.cover}`),"pid79","silently"),!1):(a(new Error(`Video url not in tiktok.com: ${e.video.playAddr}`),"pid72","silently"),!1)):(a(new Error(JSON.stringify(e.video)),"pid39","silently"),!1):(a(new Error(JSON.stringify(e.video)),"pid35","silently"),!1):(console.error("No downloadAddr"),!1):(a(new Error(JSON.stringify(e)),"pid27","silently"),!1)}const Ce=new class{constructor(){this.ue={}}L(e){this.ue=e}};function _e(){try{return g(Ce.ue.unlocks.likeLevel).cap}catch(e){return a(e,"ud17"),0}}function ke(){return Ce.ue.profile.uid}const be={async fe(){const e=await Z.O;return await e.get("likesCache",ke())||[]},L:async e=>(await Z.O).put("likesCache",e,ke()),async he(){N(await this.fe())&&await this.L([])},async W(e){return(await this.fe()).map((e=>e.id)).includes(e.id)}},Pe={we:!1};async function Te(){const e=await async function(){const e=[];let t="0",i=!0,o=0,r=0;for(await be.he();i;){await y(1e3);const s=new I("likes").k(t).T(30),c=await window.fetch(s.D(),{credentials:"include"}),l=await c.json(),{statusCode:d,itemList:u}=l;if(0!==d){if(o++,o<=3)continue;a(new Error(`Err fetching likes: ${s.D()}`),"ff30");break}if(o=0,u){if(u.some((e=>!ve(e)))){if(r++,r<=3)continue;a(new Error("still flawed"),"ff51","silently")}r=0,e.push(...u.map(_).filter(ve)),n(9,{currentTotal:e.length})}if(0===e.length)return[];if(await be.W(e[e.length-1]))break;({cursor:t,hasMore:i}=l)}return e}(),t=await be.fe(),i=Q(e.concat(t));await be.L(i)}var De,Se,Ie,Ee,$e,Ae,Be,ze,Ne;const xe=new(Ne=class{constructor(){De.add(this),Se.set(this,[]),Ie.set(this,!1),Ee.set(this,0)}async pe(){w(this,Ie,!0,"f"),await y(1e3),A.N.M("paused"),f.l()}async ye(){w(this,Ie,!1,"f")}async ge(){var e;await h(this,De,"m",Ae).call(this);try{if(0===h(this,Se,"f").length)return void n(10);if(!Pe.we)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");f.i.likes.officialList=h(this,Se,"f").map((e=>e.id)),A.N.R({total:h(this,Se,"f").length,nowAt:0});const{finalDownloadOutcome:t}=await h(this,De,"m",Be).call(this);if("someUrlExpired"===t)return w(this,Ee,1+(e=+h(this,Ee,"f")),"f"),e>3?void a(new Error("Session too long, please reload"),"bl46"):void this.ge();h(this,De,"m",ze).call(this,t)}catch(e){a(e,"bl50")}}},Se=new WeakMap,Ie=new WeakMap,Ee=new WeakMap,De=new WeakSet,$e=function(){return f.i.likes.downloaded.size>=_e()},Ae=async function(){try{await Te(),f.i.likes.lastRun.collect=Date.now(),w(this,Se,await be.fe(),"f")}catch(e){throw a(e,"bl32"),e}},Be=async function(){let e=!1;for(const[t,i]of h(this,Se,"f").reverse().entries()){const n=new de(i,"liked");if(n.X(),!n.G&&!e)if(h(this,De,"m",$e).call(this))e=!0;else{for(;h(this,Ie,"f");)await y(1e3);if(n.Y())return{finalDownloadOutcome:"someUrlExpired"};A.N.M("downloading"),A.N.R({total:h(this,Se,"f").length,nowAt:t+1}),n.Z().catch((e=>a(e,"bl75","silently"))),h(this,Ie,"f")||await y(6e3)}}return{finalDownloadOutcome:e?"capped":"completed"}},ze=async function(e){const t={officialListLength:f.i.likes.officialList.length,numMp4InLocalFolder:f.i.likes.downloaded.size,status:e};n(12,t),A.N.M(e),f.i.likes.lastRun.download=Date.now(),await f.l()},Ne);function Re(e){n(6,e)}let Me=!1;var Oe,je,Le,We,Ue,Fe,Ke,He,Ve,qe,Je;const Ge=new(Je=class{constructor(){Oe.add(this),je.set(this,null)}me(){var e;h(this,Oe,"m",Le).call(this),n(5),null===(e=document.getElementById("myfaveTT-container"))||void 0===e||e.appendChild(h(this,je,"f"))}},je=new WeakMap,Oe=new WeakSet,Le=function(){w(this,je,document.createElement("div"),"f"),h(this,je,"f").id="dropbox",h(this,je,"f").innerHTML='<svg viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"></path></svg>',h(this,je,"f").addEventListener("dragover",(e=>{e.preventDefault()})),h(this,je,"f").addEventListener("dragenter",(()=>{h(this,Oe,"m",We).call(this)})),h(this,je,"f").addEventListener("dragleave",(()=>{h(this,Oe,"m",Ue).call(this)})),h(this,je,"f").addEventListener("drop",(e=>{try{h(this,Oe,"m",Fe).call(this,e)}catch(e){a(e,"db30","silently")}}))},We=function(){var e;null===(e=h(this,je,"f"))||void 0===e||e.classList.add("dragging-over")},Ue=function(){var e;null===(e=h(this,je,"f"))||void 0===e||e.classList.remove("dragging-over")},Fe=async function(e){if(e.preventDefault(),h(this,Oe,"m",Ue).call(this),!e.dataTransfer)return void h(this,Oe,"m",Ke).call(this);if(1!==e.dataTransfer.items.length)return void h(this,Oe,"m",Ke).call(this);const t=e.dataTransfer.items[0];if("file"!==t.kind)return void h(this,Oe,"m",Ke).call(this);const i=await t.getAsFileSystemHandle();if(i&&"directory"===i.kind)try{h(this,Oe,"m",He).call(this,i)}catch(e){a(e,"db67")}else h(this,Oe,"m",Ke).call(this)},Ke=function(){Re({dropResult:"not_a_folder"})},He=async function(e){if("granted"!==await e.requestPermission({mode:"readwrite"}))return;if(!await async function(e){if(await async function(e){const t=[];for await(const i of e.keys())t.push(i);return 0===t.length}(e))return!!Me||(Me=!0,!Ce.ue.behavior.hasCreatedArchiveFolder||(Re({dropResult:"unexpectedly_empty"}),!1));try{await e.getFileHandle("Archive.html");const t=await e.getDirectoryHandle("data"),i=await t.getDirectoryHandle(".appdata");return await i.getFileHandle("app.js"),!0}catch(e){return Re({dropResult:"content_seems_wrong"}),!1}}(e))return;const t=await async function(e){const t=await d(e,"data/.appdata/db.js"),i=await t.getFile(),n=l(await i.text()),{id:o,uid:r,uniqueId:a,nickname:s}=Ce.ue.profile;return n.user.id.length>0&&n.user.id!==o?(Re({dropResult:"belongs_to_another_tiktok_account",belongsToUser:n.user.uniqueId}),null):(n.user={uid:r,id:o,uniqueId:a,nickname:s},n)}(e);t&&h(this,Oe,"m",Ve).call(this,e,t)},Ve=async function(e,t){Pe.we||o("is_resync_ready"),i(7),await f.o(e,t),"following"===A.S?me.le():xe.ge(),h(this,Oe,"m",qe).call(this)},qe=function(){var e;null===(e=h(this,je,"f"))||void 0===e||e.remove(),w(this,je,null,"f")},Je);let Ye="";async function Ze(t){var i;const{origin:o,data:{type:s,payload:c}}=t;if(o===e)switch(s){case"resync_is_ready":Pe.we=!0;break;case"resynced":{const{tempStorageKey:e,arrayBuffer:t}=c;ie.H(e,t);break}case 1:try{A.S="likes",f.t?xe.ge():Ge.me()}catch(e){a(e,"om46")}break;case 2:try{A.S="following",f.t?me.le():Ge.me()}catch(e){a(e,"om55")}break;case 3:null===(i=document.getElementById("myfaveTT-container"))||void 0===i||i.remove(),document.body.classList.remove("pushed-by-myfaveTT");break;case 4:f.u(c);break;case 0:if(n(0,"1.1.6"),"initial"===P.m){if(await P.C(),"error"===P.m)break;if(!P._())break}n(4,function(){const e=P.v.$user;return{id:(null==e?void 0:e.uid)||null,secUid:(null==e?void 0:e.secUid)||null,uniqueId:(null==e?void 0:e.uniqueId)||null,nickname:(null==e?void 0:e.nickName)||null}}()),r("Is supplement installed?");break;case 5:xe.pe();break;case 6:xe.ye();break;case 7:Ce.L(c);break;case 8:me.de(c)}}t.onmessage=async function(e){const{type:t,payload:i}=e.data;if("Supplement is installed."!==t)if(Ye!==(Ye=JSON.stringify(e.data)))if("Bottom!"!==t){if("captured header"===t){const e=await async function(e){const t=e.filter((e=>"x-tt-params"===e.name))[0],i={[t.name]:t.value,Accept:"application/json, text/plain, text/csv, */*"};let n=0,o=0;for(;;){await y(1e3);const e=await fetch("https://m.tiktok.com/api/post/item_list/",{headers:i,credentials:"include"}),t=await e.json(),{statusCode:r,itemList:s}=t;if(0!==r){if(n++,n<=3)continue;return a(new Error("Error in repeat captured request. "),"bf31"),[]}if(!s)return[];if(s.some((e=>!ve(e)))){if(o++,o<=3)continue;a(new Error("still flawed"),"bf45","silently")}return s.map(_).filter(ve)}}(i);await ue.ie(e)}}else ue.ne();else console.error("double listener?!");else n(3)};try{window.removeEventListener("message",Ze),window.addEventListener("message",(e=>{try{Ze(e)}catch(e){a(e,"om20")}}))}catch(e){a(e,"st8")}
